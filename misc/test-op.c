/* Copyright 2018  Peter Lund <firefly@vax64.dk>

   Licensed under GPL v2.

   ---

   Test bench for autogenerated operand handling for asm/dis/sim

 */

/* necessary for clock_gettime() and related types and constants.

   (If the compiler is invoked with -std=gnu99 -- or if it defaults to that
   -- then this #define is unnecessary.
   It has to be there if the compiler is invoked with -std=c99.)
 */
#define _POSIX_C_SOURCE 199309L

#include <assert.h>
#include <ctype.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <sys/stat.h>
#include <sys/types.h>

#include <time.h>

#if 0
/* declare the functions as static so they can be fully inlined */
#  define STATIC static
#else
/* ... or not, so we can see what code they compile to */
#  define STATIC
#endif


#include "vax-ucode.h"
#include "op-sim-support.h"
#include "op-sim.h"

#include "op-asm-support.h"
#include "op-asm.h"

#include "op-dis-support.h"
#include "op-dis.h"

#include "op-val-support.h"
#include "op-val.h"


#include "parse.h"
#include "big-int.h"


/***/

#define NORM	"\x1B[0m"
#define BOLD	"\x1B[41m"	/* red background */
#define GREEN	"\x1B[42;30m"	/* green background, black foreground */

/***/

#define C(x)	if (!(x)) { printf("Error [%-4d]: %s\n", __LINE__, #x); exit(1); }
#define T(x)	printf("%s:\n", x);

void test_parse_int()
{
	struct big_int	x;

/* FIXME test parse_ok afterwards! */

	T("1 - 0a");
	  parse_init("");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 0b");
	  parse_init("-");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 0c");
	  parse_init("+");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 0d");
	  parse_init(",");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 1");
	  parse_init("0");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0);

	T("1 - 2");
	  parse_init("9");
	C(parse_bigint(&x, 1))
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 9);

	T("1 - 3");
	  parse_init("0 ");
	C(parse_bigint(&x, 1));
	C(parse_ch(' '));
	  parse_done();
	C(x.val[0] == 0);

	T("1 - 4");
	  parse_init("9 ");
	C(parse_bigint(&x, 1));
	C(parse_ch(' '));
	  parse_done();
	C(x.val[0] == 9);

	T("1 - 5");
	  parse_init("9,");
	C(parse_bigint(&x, 1));
	C(parse_ch(','));
	  parse_done();
	C(x.val[0] == 9);

	T("1 - 6");
	  parse_init("9.");
	C(parse_bigint(&x, 1));
	C(parse_ch('.'));
	  parse_done();
	C(x.val[0] == 9);

	T("1 - 7");
	  parse_init("19");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 19);

	T("1 - 8");
	  parse_init("255");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 255);

	T("1 - 9");
	  parse_init("256");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 10");
	  parse_init("-127");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFF81);

	T("1 - 11");
	  parse_init("-128");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFF80);

	T("1 - 12");
	  parse_init("0x12");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x12);

	T("1 - 13");
	  parse_init("0x99");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x99);

	T("1 - 14");
	  parse_init("0xFF");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFF);

	T("1 - 15");
	  parse_init("^X0");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0);

	T("1 - 16");
	  parse_init("^X12");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x12);

	T("1 - 17");
	  parse_init("^XFF");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFF);

	T("1 - 18");
	  parse_init("-^x80");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 18b");
	  parse_init("-^X80");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFF80);

	T("1 - 19");
	  parse_init("-0x12");
	C(parse_bigint(&x, 1));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFFEE);

	T("1 - 20");
	  parse_init("0x100");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 21");
	  parse_init("-0x81");
	C(parse_bigint(&x, 1));	/* I actually want this to fail -- I think */
	  parse_done();
	C(x.val[0] == 0xFFFFFF7F);

	T("1 - 22");
	  parse_init("0x123456");
	C(!parse_bigint(&x, 1));
	  parse_done();

	T("1 - 23");
	  parse_init("0x123456789ABCDEF0");
	C(!parse_bigint(&x, 1));
	  parse_done();

	/***/

	T("2 - 1");
	  parse_init("0");
	C(parse_bigint(&x, 2));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0);

	T("2 - 2");
	  parse_init("9");
	C(parse_bigint(&x, 2));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 9);

	T("2 - 3");
	  parse_init("9999");
	C(parse_bigint(&x, 2));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 9999);

	T("2 - 4");
	  parse_init("99999");
	C(!parse_bigint(&x, 2));
	  parse_done();

	T("2 - 5");
	  parse_init("65535");
	C(parse_bigint(&x, 2));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 65535);

	T("2 - 6");
	  parse_init("65536");
	C(!parse_bigint(&x, 2));
	  parse_done();

	T("2 - 7");
	  parse_init("-32768");
	C(parse_bigint(&x, 2));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFF8000);

	T("2 - 8");
	  parse_init("-32769");
	C(parse_bigint(&x, 2));		/* I think I want this to fail */
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFF7FFF);

	T("2 - 9");
	  parse_init("0xFFFF");
	C(parse_bigint(&x, 2));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFF);

	T("2 - 10");
	  parse_init("0x10000");
	C(!parse_bigint(&x, 2));
	  parse_done();

	T("2 - 11");
	  parse_init("^XFFFF");
	C(parse_bigint(&x, 2));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFF);

	T("2 - 12");
	  parse_init("^X10000");
	C(!parse_bigint(&x, 2));
	  parse_done();

	/***/

	T("4 - 1");
	  parse_init("0");
	C(parse_bigint(&x, 4));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0);

	T("4 - 2");
	  parse_init("4000111222");
	C(parse_bigint(&x, 4));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 4000111222);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("4 - 3");
	  parse_init("0xFFFFFFFF");
	C(parse_bigint(&x, 4));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFFFF);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("4 - 4");
	  parse_init("0x1FFFFFFFF");
	C(!parse_bigint(&x, 4));
	  parse_done();

	T("4 - 5");
	  parse_init("-0x7FFFFFFF");
	C(parse_bigint(&x, 4));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x80000001);
	C(x.val[1] == 0xFFFFFFFF);
	C(x.val[2] == 0xFFFFFFFF);
	C(x.val[3] == 0xFFFFFFFF);

	/***/

	T("8 - 1");
	  parse_init("0");
	C(parse_bigint(&x, 8));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("8 - 2");
	  parse_init("0xFFFF_FFFF_FFFF_FFFF");
	C(parse_bigint(&x, 8));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFFFF);
	C(x.val[1] == 0xFFFFFFFF);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("8 - 3");
	  parse_init("0x1_FFFF_FFFF_FFFF_FFFF");
	C(!parse_bigint(&x, 8));
	  parse_done();

	T("8 - 4");
	  parse_init("-0x7FFF_FFFF_FFFF_FFFF");
	C(parse_bigint(&x, 8));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00000001);
	C(x.val[1] == 0x80000000);
	C(x.val[2] == 0xFFFFFFFF);
	C(x.val[3] == 0xFFFFFFFF);

	/***/

	T("16 - 1");
	  parse_init("0000");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("16 - 2");
	  parse_init("999");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 999);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);


	T("16 - 3");
	  parse_init("0xFFFF_FFFF_FFFF_FFFF__FFFF_FFFF_FFFF_FFFF");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFFFF);
	C(x.val[1] == 0xFFFFFFFF);
	C(x.val[2] == 0xFFFFFFFF);
	C(x.val[3] == 0xFFFFFFFF);

	T("16 - 4");
	  parse_init("0x1234_5678_9ABC_DEF0__4321_8765_CBA9_0FED");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xCBA90FED);
	C(x.val[1] == 0x43218765);
	C(x.val[2] == 0x9ABCDEF0);
	C(x.val[3] == 0x12345678);

	T("16 - 5");
	  parse_init("0x1_FFFF_FFFF_FFFF_FFFF__FFFF_FFFF_FFFF_FFFF");
	C(!parse_bigint(&x, 16));
	  parse_done();

	T("16 - 6");
	  parse_init("-1");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xFFFFFFFF);
	C(x.val[1] == 0xFFFFFFFF);
	C(x.val[2] == 0xFFFFFFFF);
	C(x.val[3] == 0xFFFFFFFF);

	T("16 - 7");
	  parse_init("-0xFFFF_FFFF_FFFF_FFFF__FFFF_FFFF_FFFF_FFFF");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 1);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("16 - 8");
	  parse_init("-0x7FFF_FFFF_FFFF_FFFF__FFFF_FFFF_FFFF_FFFF");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00000001);
	C(x.val[1] == 0x00000000);
	C(x.val[2] == 0x00000000);
	C(x.val[3] == 0x80000000);

	T("16 - 9");
	  parse_init("-0x8000_0000_0000_0000__0000_0000_0000_0000");
	C(parse_bigint(&x, 16));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00000000);
	C(x.val[1] == 0x00000000);
	C(x.val[2] == 0x00000000);
	C(x.val[3] == 0x80000000);
}



/* VAX fp values are 0.0 if exp=0, s=0 (so -0.0 doesn't exist on the VAX).
   They are called clean zeros if frac=0, otherwise they are called dirty zeros.
 */
void test_parse_fp()
{
	struct big_int	x;

/* FIXME test parse_ok afterwards! */

	T("f -- 0");
	  parse_init("...");
	C(!parse_fp(&x, 'f'));
	  parse_done();

	T("f -- 1");
	  parse_init("");
	C(!parse_fp(&x, 'f'));
	  parse_done();

	T("f -- 2");
	  parse_init("0");
	C(parse_fp(&x, 'f'))
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 3");
	  parse_init("1");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00004080);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 4");
	  parse_init("1.");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00004080);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 5");
	  parse_init("1.0");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00004080);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 6");
	  parse_init("1.00");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00004080);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 7");
	  parse_init("001");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x00004080);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 8");
	  parse_init("1.1");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xCCCD408C);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 9");
	  parse_init("1.1415");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x1CAC4092);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 10");
	  parse_init("123.1");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x333343F6);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 11");
	  parse_init("123.1,");
	C(parse_fp(&x, 'f'));
	C(parse_ch(','));
	  parse_done();
	C(x.val[0] == 0x333343F6);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 12");
	  parse_init("123.1 ");
	C(parse_fp(&x, 'f'));
	C(parse_ch(' '));
	  parse_done();
	C(x.val[0] == 0x333343F6);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 13");
	  parse_init("123.1.");
	C(parse_fp(&x, 'f'));
	C(parse_ch('.'));
	  parse_done();
	C(x.val[0] == 0x333343F6);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 14");
	  parse_init("-123.1");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x3333C3F6);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 15");
	  parse_init("123.1E3");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x6E0048F0);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 16");
	  parse_init("123.1E-3");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0x1BDA3EFC);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 17");
	  parse_init("123.1E12");
	C(parse_fp(&x, 'f'));
	C(parse_eof());
	  parse_done();
	C(x.val[0] == 0xEAE857DF);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	T("f -- 18");
	  parse_init("123.1E-12,");
	C(parse_fp(&x, 'f'));
	C(parse_ch(','));
	  parse_done();
	C(x.val[0] == 0x59923007);
	C(x.val[1] == 0);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	/***/

	T("d - 1");
	  parse_init("123.1E-12,");
	C(parse_fp(&x, 'd'));
	C(parse_ch(','));
	  parse_done();
	C(x.val[0] == 0x59913007);
	C(x.val[1] == 0x40DAD379);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	/***/

	T("g - 1");
	  parse_init("123.1E-12,");
	C(parse_fp(&x, 'g'));
	C(parse_ch(','));
	  parse_done();
	C(x.val[0] == 0xEB323E00);
	C(x.val[1] == 0x281B3A6F);
	C(x.val[2] == 0);
	C(x.val[3] == 0);

	/***/

	T("h - 1");
	  parse_init("123.1E-123,");
	C(parse_fp(&x, 'h'));
	C(parse_ch(','));
	  parse_done();
	C(x.val[0] == 0x45813E6F);
	C(x.val[1] == 0x8A540375);
	C(x.val[2] == 0x5C0AD539);
	C(x.val[3] == 0xDE8F79D7);

}


void test_parse()
{
	test_parse_int();
	test_parse_fp();
}


/***/


/* test parse_branch8/parse_branch16 ('bb'/'bw') */
void parse_branch_displacements()
{
	int	testcnt=0;
	int	passcnt=0;

	/* first test with displacements from 0x0000_0000 (tests wrap-arounds) */
	struct {
		const char	*str;
		bool		 ok;
		uint8_t		 disp;
	} test_8a [] = {
	{.str="",       .ok=false},
	{.str="   \t\t",.ok=false},
	{.str=" 7",     .ok=true, .disp=7},
	{.str="\t\t  \t7", .ok=true, .disp=7},
	{.str="0",      .ok=true, .disp=0},
	{.str="1",      .ok=true, .disp=1},
	{.str="2",      .ok=true, .disp=2},
	{.str="0x7F",   .ok=true, .disp=0x7F},
	{.str="^X7F",   .ok=true, .disp=0x7F},
	{.str="0x7f",   .ok=true, .disp=0x7F},
	{.str="^X7f",   .ok=true, .disp=0x7F},
	{.str="0x80",   .ok=false},
	{.str="0xFF",   .ok=false},
	{.str="0x100",  .ok=false},
	{.str="0xFFFF_FFFF", .ok=true, .disp=0xFF},
	{.str="0xFFFF_FFFE", .ok=true, .disp=0xFE},
	{.str="0xFFFF_FF80", .ok=true, .disp=0x80},
	{.str="0xFFFF_FF7F", .ok=false}
	};

	for (unsigned i=0; i < ARRAY_SIZE(test_8a); i++) {
		uint8_t		disp;
		bool		ok;

		testcnt++;

		parse_init(test_8a[i].str);
		ok = parse_branch8(&disp, 0x00000000);
		if (ok != test_8a[i].ok) {
			printf("test_8a %3d: |%s| %s (should be %s)\n",
				i,
				test_8a[i].str,
				test_8a[i].ok ? "true" : "false",
				ok ? "true" : "false");
			goto DONE_8a;
		}

		if (!ok) {
			passcnt++;
			goto DONE_8a;
		}

		if (disp != test_8a[i].disp) {
			printf("test_8a %3d: |%s| disp=%02X (should be %02X)\n",
				i,
				test_8a[i].str,
				disp, test_8a[i].disp);
			goto DONE_8a;
		}
		if (!parse_eof()) {
			printf("test_8a %3d: |%s| not eof\n",
				i,
				test_8a[i].str);
			goto DONE_8a;
		}

		passcnt++;
DONE_8a:
		parse_done();
	}

	/* then test with displacements from 0x0000_1003 */
	struct {
		const char	*str;
		bool		 ok;
		uint8_t		 disp;
	} test_8b [] = {
	{.str="0x0000_1003", .ok=true, .disp=0},
	{.str="0x0000_1004", .ok=true, .disp=1},
	{.str="0x0000_1005", .ok=true, .disp=2},
	{.str="0x0000_1082", .ok=true, .disp=0x7F},
	{.str="^X0000_1082", .ok=true, .disp=0x7F},
	{.str="0x0000_1082", .ok=true, .disp=0x7F},
	{.str="^X0000_1082", .ok=true, .disp=0x7F},
	{.str="0x0000_1083", .ok=false},
	{.str="0x0000_1102", .ok=false},
	{.str="0x0000_1103", .ok=false},
	{.str="0x0000_1002", .ok=true, .disp=0xFF},
	{.str="0x0000_1001", .ok=true, .disp=0xFE},
	{.str="0x0000_0F83", .ok=true, .disp=0x80},
	{.str="0x0000_0F82", .ok=false}
	};

	for (unsigned i=0; i < ARRAY_SIZE(test_8b); i++) {
		uint8_t		disp;
		bool		ok;

		testcnt++;

		parse_init(test_8b[i].str);
		ok = parse_branch8(&disp, 0x00001003);
		if (ok != test_8b[i].ok) {
			printf("test_8b %3d: |%s| %s (should be %s)\n",
				i,
				test_8b[i].str,
				test_8b[i].ok ? "true" : "false",
				ok ? "true" : "false");
			goto DONE_8b;
		}

		if (!ok) {
			passcnt++;
			goto DONE_8b;
		}

		if (disp != test_8b[i].disp) {
			printf("test_8b %3d: |%s| disp=%02X (should be %02X)\n",
				i,
				test_8b[i].str,
				disp, test_8b[i].disp);
			goto DONE_8b;
		}
		if (!parse_eof()) {
			printf("test_8b %3d: |%s| not eof\n",
				i,
				test_8b[i].str);
			goto DONE_8b;
		}

		passcnt++;
DONE_8b:
		parse_done();
	}

	/* first test with displacements from 0x0000_0000 (tests wrap-arounds) */
	struct {
		const char	*str;
		bool		 ok;
		uint16_t		 disp;
	} test_16a [] = {
	{.str="",       .ok=false},
	{.str="   \t\t",.ok=false},
	{.str=" 7",     .ok=true, .disp=7},
	{.str="\t\t  \t7", .ok=true, .disp=7},
	{.str="0",      .ok=true, .disp=0},
	{.str="1",      .ok=true, .disp=1},
	{.str="2",      .ok=true, .disp=2},
	{.str="0x7F",   .ok=true, .disp=0x7F},
	{.str="^X7F",   .ok=true, .disp=0x7F},
	{.str="0x7f",   .ok=true, .disp=0x7F},
	{.str="^X7f",   .ok=true, .disp=0x7F},
	{.str="0x80",   .ok=true, .disp=0x80},
	{.str="0xFF",   .ok=true, .disp=0xFF},
	{.str="0x100",  .ok=true, .disp=0x100},
	{.str="0x7FFF", .ok=true, .disp=0x7FFF},
	{.str="0x8000", .ok=false},
	{.str="0x10000", .ok=false},
	{.str="0x10100", .ok=false},
	{.str="0xFFFF_FFFF", .ok=true, .disp=0xFFFF},
	{.str="0xFFFF_FFFE", .ok=true, .disp=0xFFFE},
	{.str="0xFFFF_FF80", .ok=true, .disp=0xFF80},
	{.str="0xFFFF_FF7F", .ok=true, .disp=0xFF7F},
	{.str="0xFFFF_8000", .ok=true, .disp=0x8000},
	{.str="0xFFFF_7FFF", .ok=false},
	};

	for (unsigned i=0; i < ARRAY_SIZE(test_16a); i++) {
		uint16_t	disp;
		bool		ok;

		testcnt++;

		parse_init(test_16a[i].str);
		ok = parse_branch16(&disp, 0x00000000);
		if (ok != test_16a[i].ok) {
			printf("test_16a %3d: |%s| %s (should be %s)\n",
				i,
				test_16a[i].str,
				test_16a[i].ok ? "true" : "false",
				ok ? "true" : "false");
			goto DONE_16a;
		}

		if (!ok) {
			passcnt++;
			goto DONE_16a;
		}

		if (disp != test_16a[i].disp) {
			printf("test_16a %3d: |%s| disp=%02X (should be %02X)\n",
				i,
				test_16a[i].str,
				disp, test_16a[i].disp);
			goto DONE_16a;
		}
		if (!parse_eof()) {
			printf("test_16a %3d: |%s| not eof\n",
				i,
				test_16a[i].str);
			goto DONE_16a;
		}

		passcnt++;
DONE_16a:
		parse_done();
	}

	/* then test with displacements from 0x0000_1003 */
	struct {
		const char	*str;
		bool		 ok;
		uint16_t	 disp;
	} test_16b [] = {
	{.str="0x0000_1003", .ok=true, .disp=0},
	{.str="0x0000_1004", .ok=true, .disp=1},
	{.str="0x0000_1005", .ok=true, .disp=2},
	{.str="0x0000_1082", .ok=true, .disp=0x7F},
	{.str="^X0000_1082", .ok=true, .disp=0x7F},
	{.str="0x0000_1082", .ok=true, .disp=0x7F},
	{.str="^X0000_1082", .ok=true, .disp=0x7F},
	{.str="0x0000_1083", .ok=true, .disp=0x80},
	{.str="0x0000_1123", .ok=true, .disp=0x120},
	{.str="0x0000_9002", .ok=true, .disp=0x7FFF},
	{.str="0x0000_9003", .ok=false},
	{.str="0x0001_1003", .ok=false},
	{.str="0x0000_1002", .ok=true, .disp=0xFFFF},
	{.str="0x0000_1001", .ok=true, .disp=0xFFFE},
	{.str="0x0000_0F83", .ok=true, .disp=0xFF80},
	{.str="0xFFFF_9003", .ok=true, .disp=0x8000},
	{.str="0xFFFF_9002", .ok=false}
	};

	for (unsigned i=0; i < ARRAY_SIZE(test_16b); i++) {
		uint16_t		disp;
		bool			ok;

		testcnt++;

		parse_init(test_16b[i].str);
		ok = parse_branch16(&disp, 0x00001003);
		if (ok != test_16b[i].ok) {
			printf("test_16b %3d: |%s| %s (should be %s)\n",
				i,
				test_16b[i].str,
				test_16b[i].ok ? "true" : "false",
				ok ? "true" : "false");
			goto DONE_16b;
		}

		if (!ok) {
			passcnt++;
			goto DONE_16b;
		}

		if (disp != test_16b[i].disp) {
			printf("test_16b %3d: |%s| disp=%02X (should be %02X)\n",
				i,
				test_16b[i].str,
				disp, test_16b[i].disp);
			goto DONE_16b;
		}
		if (!parse_eof()) {
			printf("test_16b %3d: |%s| not eof\n",
				i,
				test_16b[i].str);
			goto DONE_16b;
		}

		passcnt++;
DONE_16b:
		parse_done();
	}

	printf("%d/%d tests passed (parse_branch8/parse_branch16)\n", passcnt, testcnt);
}



struct test_asm_case {
	const char	*str;
	int		 cnt;
	uint8_t		 b[MAX_OPLEN];
	uint32_t	 pc;
	int		 width;
	enum ifp	 ifp;
};

struct test_asm_case asm_vax[] = {
	{.str="S^#0",		.cnt=1, .b={0x00}, .width=1, .ifp=IFP_INT},
	{.str="S^#63",		.cnt=1, .b={0x3F}, .width=1, .ifp=IFP_INT},
	{.str="S^#64",		.cnt=-1,           .width=1, .ifp=IFP_INT},

	/* 000.000 */
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width=16, .ifp=IFP_H},

	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width=16, .ifp=IFP_H},

	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width=16, .ifp=IFP_H},

	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width=16, .ifp=IFP_H},

	/* 000.100 */
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width=16, .ifp=IFP_H},

	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width=16, .ifp=IFP_H},

	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width=16, .ifp=IFP_H},

	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width=16, .ifp=IFP_H},

	/* 001.000 */
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 4, .ifp=IFP_F},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 8, .ifp=IFP_D},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 8, .ifp=IFP_G},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width=16, .ifp=IFP_H},

	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width=16, .ifp=IFP_H},

	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width=16, .ifp=IFP_H},

	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width=16, .ifp=IFP_H},

	/* 001.100 */
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width=16, .ifp=IFP_H},

	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width=16, .ifp=IFP_H},

	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width=16, .ifp=IFP_H},

	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width=16, .ifp=IFP_H},

	/* 010.000 */
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 4, .ifp=IFP_F},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 8, .ifp=IFP_D},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 8, .ifp=IFP_G},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width=16, .ifp=IFP_H},

	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width=16, .ifp=IFP_H},

	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width=16, .ifp=IFP_H},

	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width=16, .ifp=IFP_H},

	/* 010.100 */
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 4, .ifp=IFP_F},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 8, .ifp=IFP_D},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 8, .ifp=IFP_G},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width=16, .ifp=IFP_H},

	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width=16, .ifp=IFP_H},

	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width=16, .ifp=IFP_H},

	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width=16, .ifp=IFP_H},

	/* 011.000 */
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 4, .ifp=IFP_F},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 8, .ifp=IFP_D},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 8, .ifp=IFP_G},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width=16, .ifp=IFP_H},

	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 4, .ifp=IFP_F},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 8, .ifp=IFP_D},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 8, .ifp=IFP_G},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width=16, .ifp=IFP_H},

	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 4, .ifp=IFP_F},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 8, .ifp=IFP_D},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 8, .ifp=IFP_G},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width=16, .ifp=IFP_H},

	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 4, .ifp=IFP_F},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 8, .ifp=IFP_D},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 8, .ifp=IFP_G},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width=16, .ifp=IFP_H},

	/* 011.100 */
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 4, .ifp=IFP_F},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 8, .ifp=IFP_D},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 8, .ifp=IFP_G},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width=16, .ifp=IFP_H},

	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 4, .ifp=IFP_F},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 8, .ifp=IFP_D},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 8, .ifp=IFP_G},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width=16, .ifp=IFP_H},

	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 4, .ifp=IFP_F},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 8, .ifp=IFP_D},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 8, .ifp=IFP_G},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width=16, .ifp=IFP_H},

	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 4, .ifp=IFP_F},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 8, .ifp=IFP_D},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 8, .ifp=IFP_G},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width=16, .ifp=IFP_H},

	/* 100.000 */
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 4, .ifp=IFP_F},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 8, .ifp=IFP_D},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 8, .ifp=IFP_G},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width=16, .ifp=IFP_H},

	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 4, .ifp=IFP_F},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 8, .ifp=IFP_D},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 8, .ifp=IFP_G},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width=16, .ifp=IFP_H},

	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 4, .ifp=IFP_F},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 8, .ifp=IFP_D},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 8, .ifp=IFP_G},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width=16, .ifp=IFP_H},

	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 4, .ifp=IFP_F},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 8, .ifp=IFP_D},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 8, .ifp=IFP_G},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width=16, .ifp=IFP_H},

	/* 100.100 */
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 4, .ifp=IFP_F},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 8, .ifp=IFP_D},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 8, .ifp=IFP_G},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width=16, .ifp=IFP_H},

	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 4, .ifp=IFP_F},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 8, .ifp=IFP_D},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 8, .ifp=IFP_G},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width=16, .ifp=IFP_H},

	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 4, .ifp=IFP_F},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 8, .ifp=IFP_D},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 8, .ifp=IFP_G},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width=16, .ifp=IFP_H},

	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 4, .ifp=IFP_F},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 8, .ifp=IFP_D},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 8, .ifp=IFP_G},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width=16, .ifp=IFP_H},

	/* 101.000 */
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 4, .ifp=IFP_F},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 8, .ifp=IFP_D},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 8, .ifp=IFP_G},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width=16, .ifp=IFP_H},

	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 4, .ifp=IFP_F},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 8, .ifp=IFP_D},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 8, .ifp=IFP_G},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width=16, .ifp=IFP_H},

	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 4, .ifp=IFP_F},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 8, .ifp=IFP_D},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 8, .ifp=IFP_G},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width=16, .ifp=IFP_H},

	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 4, .ifp=IFP_F},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 8, .ifp=IFP_D},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 8, .ifp=IFP_G},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width=16, .ifp=IFP_H},

	/* 101.100 */
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 4, .ifp=IFP_F},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 8, .ifp=IFP_D},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 8, .ifp=IFP_G},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width=16, .ifp=IFP_H},

	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 4, .ifp=IFP_F},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 8, .ifp=IFP_D},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 8, .ifp=IFP_G},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width=16, .ifp=IFP_H},

	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 4, .ifp=IFP_F},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 8, .ifp=IFP_D},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 8, .ifp=IFP_G},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width=16, .ifp=IFP_H},

	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 4, .ifp=IFP_F},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 8, .ifp=IFP_D},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 8, .ifp=IFP_G},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width=16, .ifp=IFP_H},

	/* 110.000 */
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 4, .ifp=IFP_F},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 8, .ifp=IFP_D},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 8, .ifp=IFP_G},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width=16, .ifp=IFP_H},

	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 4, .ifp=IFP_F},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 8, .ifp=IFP_D},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 8, .ifp=IFP_G},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width=16, .ifp=IFP_H},

	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 4, .ifp=IFP_F},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 8, .ifp=IFP_D},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 8, .ifp=IFP_G},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width=16, .ifp=IFP_H},

	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 4, .ifp=IFP_F},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 8, .ifp=IFP_D},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 8, .ifp=IFP_G},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width=16, .ifp=IFP_H},

	/* 110.100 */
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 4, .ifp=IFP_F},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 8, .ifp=IFP_D},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 8, .ifp=IFP_G},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width=16, .ifp=IFP_H},

	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 4, .ifp=IFP_F},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 8, .ifp=IFP_D},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 8, .ifp=IFP_G},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width=16, .ifp=IFP_H},

	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 4, .ifp=IFP_F},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 8, .ifp=IFP_D},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 8, .ifp=IFP_G},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width=16, .ifp=IFP_H},

	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 4, .ifp=IFP_F},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 8, .ifp=IFP_D},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 8, .ifp=IFP_G},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width=16, .ifp=IFP_H},

	/* 111.000 */
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 4, .ifp=IFP_F},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 8, .ifp=IFP_D},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 8, .ifp=IFP_G},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width=16, .ifp=IFP_H},

	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 4, .ifp=IFP_F},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 8, .ifp=IFP_D},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 8, .ifp=IFP_G},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width=16, .ifp=IFP_H},

	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 4, .ifp=IFP_F},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 8, .ifp=IFP_D},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 8, .ifp=IFP_G},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width=16, .ifp=IFP_H},

	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 4, .ifp=IFP_F},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 8, .ifp=IFP_D},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 8, .ifp=IFP_G},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width=16, .ifp=IFP_H},

	/* 111.100 */
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 4, .ifp=IFP_F},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 8, .ifp=IFP_D},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 8, .ifp=IFP_G},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width=16, .ifp=IFP_H},

	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 4, .ifp=IFP_F},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 8, .ifp=IFP_D},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 8, .ifp=IFP_G},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width=16, .ifp=IFP_H},

	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 4, .ifp=IFP_F},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 8, .ifp=IFP_D},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 8, .ifp=IFP_G},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width=16, .ifp=IFP_H},

	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 4, .ifp=IFP_F},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 8, .ifp=IFP_D},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 8, .ifp=IFP_G},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width=16, .ifp=IFP_H},

	/* FIXME test fp values that don't fit into lit6 */

	/***/

	/* ints */

	/* FIXME test int values that are too large for byte/word/long/quad/octo */

	{.str="I^#0",		.cnt=2, .b={0x8F, 0x00},	.width=1, .ifp=IFP_INT},
	{.str="I^#255",		.cnt=2, .b={0x8F, 0xFF},	.width=1, .ifp=IFP_INT},

	{.str="I^#0",		.cnt=3, .b={0x8F, 0x00,0x00},	.width=2, .ifp=IFP_INT},
	{.str="I^#255",		.cnt=3, .b={0x8F, 0xFF,0x00},	.width=2, .ifp=IFP_INT},
	{.str="I^#65535",	.cnt=3, .b={0x8F, 0xFF,0xFF},	.width=2, .ifp=IFP_INT},

	{.str="I^#0",		.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00},	.width=4, .ifp=IFP_INT},
	{.str="I^#255",		.cnt=5, .b={0x8F, 0xFF,0x00,0x00,0x00},	.width=4, .ifp=IFP_INT},
	{.str="I^#^XFFFFFFFF",	.cnt=5, .b={0x8F, 0xFF,0xFF,0xFF,0xFF},	.width=4, .ifp=IFP_INT},

	{.str="I^#0",		.cnt=9, .b={0x8F, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00},	.width=8, .ifp=IFP_INT},
	{.str="I^#255",		.cnt=9, .b={0x8F, 0xFF,0x00,0x00,0x00, 0x00,0x00,0x00,0x00},	.width=8, .ifp=IFP_INT},
	{.str="I^#^XFFFFFFFFFFFFFFFF",
				.cnt=9, .b={0x8F, 0xFF,0xFF,0xFF,0xFF, 0xFF,0xFF,0xFF,0xFF},.width=8, .ifp=IFP_INT},

	{.str="I^#0",		.cnt=17, .b={0x8F, 0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00},.width=16, .ifp=IFP_INT},
	{.str="I^#255",		.cnt=17, .b={0x8F, 0xFF,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00},.width=16, .ifp=IFP_INT},
	{.str="I^#^XFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",
				.cnt=17, .b={0x8F, 0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF},.width=16, .ifp=IFP_INT},

	/* fp */

	{.str="I^#0",		.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#0.",		.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#000.000",	.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#1",		.cnt=5, .b={0x8F, 0x80,0x40,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.1",		.cnt=5, .b={0x8F, 0x8C,0x40,0xCD,0xCC}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.1415",	.cnt=5, .b={0x8F, 0x92,0x40,0xAC,0x1C}, .width= 4, .ifp=IFP_F},
	{.str="I^#123.1",	.cnt=5, .b={0x8F, 0xF6,0x43,0x33,0x33}, .width= 4, .ifp=IFP_F},
	{.str="I^#-123.1",	.cnt=5, .b={0x8F, 0xF6,0xC3,0x33,0x33}, .width= 4, .ifp=IFP_F},
	{.str="I^#123.1E3",	.cnt=5, .b={0x8F, 0xF0,0x48,0x00,0x6E}, .width= 4, .ifp=IFP_F},
	{.str="I^#123.1E-3",	.cnt=5, .b={0x8F, 0xFC,0x3E,0xDA,0x1B}, .width= 4, .ifp=IFP_F},
	{.str="I^#123.1E12",	.cnt=5, .b={0x8F, 0xDF,0x57,0xE8,0xEA}, .width= 4, .ifp=IFP_F},
	{.str="I^#123.1E-12",	.cnt=5, .b={0x8F, 0x07,0x30,0x92,0x59}, .width= 4, .ifp=IFP_F},

	{.str="I^#123.1E-12",	.cnt=9, .b={0x8F, 0x07,0x30,0x91,0x59, 0x79,0xD3,0xDA,0x40}, .width= 8, .ifp=IFP_D},
	{.str="I^#123.1E-12",	.cnt=9, .b={0x8F, 0x00,0x3E,0x32,0xEB, 0x6F,0x3A,0x1B,0x28}, .width= 8, .ifp=IFP_G},
	{.str="I^#123.1E-123",	.cnt=17,.b={0x8F, 0x6F,0x3E,0x81,0x45,
	                                          0x75,0x03,0x54,0x8A,
	                                          0x39,0xD5,0x0A,0x5C,
	                                          0xD7,0x79,0x8F,0xDE}, .width=16, .ifp=IFP_H},

	/***/

	{.str="r0",		.cnt=1, .b={0x50}, .width=1, .ifp=IFP_INT},
	{.str="r4",		.cnt=1, .b={0x54}, .width=1, .ifp=IFP_INT},
	{.str="fp",		.cnt=1, .b={0x5D}, .width=1, .ifp=IFP_INT},
	{.str="r13",		.cnt=1, .b={0x5D}, .width=1, .ifp=IFP_INT},

	{.str="(fp)",		.cnt=1, .b={0x6D}, .width=1, .ifp=IFP_INT},
	{.str="(r13)",		.cnt=1, .b={0x6D}, .width=1, .ifp=IFP_INT},

	{.str="-(fp)",		.cnt=1, .b={0x7D}, .width=1, .ifp=IFP_INT},
	{.str="-(r13)",		.cnt=1, .b={0x7D}, .width=1, .ifp=IFP_INT},

	{.str="(r2)+",		.cnt=1, .b={0x82}, .width=1, .ifp=IFP_INT},
	{.str="(r12)+",		.cnt=1, .b={0x8C}, .width=1, .ifp=IFP_INT},

	{.str="@#^X12345678",	.cnt=5, .b={0x9F, 0x78,0x56,0x34,0x12}, .width=1, .ifp=IFP_INT},

	{.str="@(fp)+",		.cnt=1, .b={0x9D}, .width=1, .ifp=IFP_INT},
	{.str="@(r12)+",	.cnt=1, .b={0x9C}, .width=1, .ifp=IFP_INT},

	/* pcrel/disp */
	/* FIXME test pcrel8/pcrel16 w/ addresses that are too far away */
	{.str="B^0xCAFEBB00",	.cnt=2, .b={0xAF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="B^100(fp)",	.cnt=2, .b={0xAD, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^^XCAFEBB00",	.cnt=2, .b={0xBF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(fp)",	.cnt=2, .b={0xBD, 0x64}, .width=1, .ifp=IFP_INT},

	{.str="W^0xCAFEC000",	.cnt=3, .b={0xCF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="W^1000(fp)",	.cnt=3, .b={0xCD, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^^XCAFEC000",	.cnt=3, .b={0xDF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(fp)",	.cnt=3, .b={0xDD, 0xE8,0x03}, .width=1, .ifp=IFP_INT},

	{.str="L^0xCC00C000",	.cnt=5, .b={0xEF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="L^100000(fp)",	.cnt=5, .b={0xED, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^^XCC00C000",	.cnt=5, .b={0xFF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(fp)",	.cnt=5, .b={0xFD, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},


	/* indexed operands */
	{.str="(r2)[fp]",		.cnt=2, .b={0x4D,0x62}, .width=1, .ifp=IFP_INT},
	{.str="-(r2)[fp]",		.cnt=2, .b={0x4D,0x72}, .width=1, .ifp=IFP_INT},
	{.str="(r2)+[fp]",		.cnt=2, .b={0x4D,0x82}, .width=1, .ifp=IFP_INT},
	{.str="@#0x12345678[fp]",	.cnt=6, .b={0x4D,0x9F, 0x78,0x56,0x34,0x12}, .width=1, .ifp=IFP_INT},
	{.str="@(r2)+[fp]",		.cnt=2, .b={0x4D,0x92}, .width=1, .ifp=IFP_INT},


	{.str="B^0xCAFEBB00[fp]",	.cnt=3, .b={0x4D,0xAF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="B^100(r2)[fp]",		.cnt=3, .b={0x4D,0xA2, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^^XCAFEBB00[fp]",	.cnt=3, .b={0x4D,0xBF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(r2)[fp]",		.cnt=3, .b={0x4D,0xB2, 0x64}, .width=1, .ifp=IFP_INT},

	{.str="W^0xCAFEC000[fp]",	.cnt=4, .b={0x4D,0xCF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="W^1000(r2)[fp]",		.cnt=4, .b={0x4D,0xC2, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^^XCAFEC000[fp]",	.cnt=4, .b={0x4D,0xDF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(r2)[fp]",	.cnt=4, .b={0x4D,0xD2, 0xE8,0x03}, .width=1, .ifp=IFP_INT},

	{.str="L^0xCC00C000[fp]",	.cnt=6, .b={0x4D,0xEF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="L^100000(r2)[fp]",	.cnt=6, .b={0x4D,0xE2, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^^XCC00C000[fp]",	.cnt=6, .b={0x4D,0xFF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(r2)[fp]",	.cnt=6, .b={0x4D,0xF2, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},

	/* check operands that are invalid (or almost invalid)
	 */

	/* operands based on the pc are usually not okay -- these certainly aren't */
	{.str="pc",			.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="-(pc)",			.cnt=-1, .width=1, .ifp=IFP_INT},
#if 0
	{.str="(pc)+",			.cnt=-1, .width=1, .ifp=IFP_INT},	/* FIXME this test fails */
	{.str="@(pc)+",			.cnt=-1, .width=1, .ifp=IFP_INT},	/* FIXME this test fails */
#endif

	/* r14 -- r14/r15, r14/r15/r16/r17 -- so 64-bit/128-bit values are not okay */
	{.str="r14",			.cnt=1, .b={0x5E}, .width= 1, .ifp=IFP_INT},
	{.str="r14",			.cnt=1, .b={0x5E}, .width= 2, .ifp=IFP_INT},
	{.str="r14",			.cnt=1, .b={0x5E}, .width= 4, .ifp=IFP_INT},
	{.str="r14",			.cnt=-1, .width= 8, .ifp=IFP_INT},
	{.str="r14",			.cnt=-1, .width=16, .ifp=IFP_INT},

	/* r13, r13/r14 -- r13/r14/r15/r16 -- so 128-bit values are not okay */
	{.str="r13",			.cnt=1, .b={0x5D}, .width= 1, .ifp=IFP_INT},
	{.str="r13",			.cnt=1, .b={0x5D}, .width= 2, .ifp=IFP_INT},
	{.str="r13",			.cnt=1, .b={0x5D}, .width= 4, .ifp=IFP_INT},
	{.str="r13",			.cnt=1, .b={0x5D}, .width= 8, .ifp=IFP_INT},
	{.str="r13",			.cnt=-1, .width=16, .ifp=IFP_INT},

	/* r12, r12/r13, r12/r13/r14/r15 -- so 128-bit values are not okay */
	{.str="r12",			.cnt=1, .b={0x5C}, .width= 1, .ifp=IFP_INT},
	{.str="r12",			.cnt=1, .b={0x5C}, .width= 2, .ifp=IFP_INT},
	{.str="r12",			.cnt=1, .b={0x5C}, .width= 4, .ifp=IFP_INT},
	{.str="r12",			.cnt=1, .b={0x5C}, .width= 8, .ifp=IFP_INT},
	{.str="r12",			.cnt=-1, .width=16, .ifp=IFP_INT},

	/* r11/r12/r13/r14 -- 8/17/32/64/128-bit values are all okay */
	{.str="r11",			.cnt=1, .b={0x5B}, .width= 1, .ifp=IFP_INT},
	{.str="r11",			.cnt=1, .b={0x5B}, .width= 2, .ifp=IFP_INT},
	{.str="r11",			.cnt=1, .b={0x5B}, .width= 4, .ifp=IFP_INT},
	{.str="r11",			.cnt=1, .b={0x5B}, .width= 8, .ifp=IFP_INT},
	{.str="r11",			.cnt=1, .b={0x5B}, .width=16, .ifp=IFP_INT},

	/* using r14 is perfectly ok */
	{.str="-(r14)",			.cnt=1, .b={0x7E}, .width= 1, .ifp=IFP_INT},
	{.str="(r14)+",			.cnt=1, .b={0x8E}, .width= 1, .ifp=IFP_INT},
	{.str="@(r14)+",		.cnt=1, .b={0x9E}, .width= 1, .ifp=IFP_INT},

	/* Rn=Rx is an error for some addressing modes */
	{.str="-(r2)[r2]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="(r2)+[r2]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="@(r2)+[r2]",		.cnt=-1, .width=1, .ifp=IFP_INT},

	/* Rn=Rx is perfectly ok for other addressing modes */
	{.str="B^100(r3)[r3]",		.cnt=3, .b={0x43,0xA3, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(r3)[r3]",		.cnt=3, .b={0x43,0xB3, 0x64}, .width=1, .ifp=IFP_INT},

	{.str="W^1000(r3)[r3]",		.cnt=4, .b={0x43,0xC3, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(r3)[r3]",	.cnt=4, .b={0x43,0xD3, 0xE8,0x03}, .width=1, .ifp=IFP_INT},

	{.str="L^100000(r3)[r3]",	.cnt=6, .b={0x43,0xE3, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(r3)[r3]",	.cnt=6, .b={0x43,0xF3, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},

	/* pc is not allowed as index register */
	{.str="(r2)[pc]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="-(r2)[pc]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="(r2)+[pc]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="@#0x12345678[pc]",	.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="@(r2)+[pc]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="B^100(r3)[pc]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="@B^100(r3)[pc]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="W^1000(r3)[pc]",		.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(r3)[pc]",	.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="L^100000(r3)[pc]",	.cnt=-1, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(r3)[pc]",	.cnt=-1, .width=1, .ifp=IFP_INT},

	/* non-standard ways to write PC-relative addresses -- all ok */
	{.str="B^100(pc)",		.cnt=2, .b={0xAF, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(pc)",		.cnt=2, .b={0xBF, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="W^1000(pc)",		.cnt=3, .b={0xCF, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(pc)",		.cnt=3, .b={0xDF, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="L^100000(pc)",		.cnt=5, .b={0xEF, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(pc)",		.cnt=5, .b={0xFF, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
};


void test_asm()
{
	int	pass_cnt = 0;

	printf("Assembler tests\n");
	printf("---------------\n");

	/* branch8/branch16 (not part of the op_asm() stuff) */
	parse_branch_displacements();

	/* op_asm() tests */
	for (unsigned tst=0; tst < ARRAY_SIZE(asm_vax); tst++) {
		uint8_t	b[MAX_OPLEN] = {};
		int	bytes;
		bool	valid;

		parse_init(asm_vax[tst].str);
		bytes = op_asm_vax(b, 0xCAFEBABE, asm_vax[tst].width, asm_vax[tst].ifp);
		/* FIXME parse_ok? parse_eof()? */
		parse_done();

		valid = (bytes != -1) ? op_val(b, asm_vax[tst].width) : false;

#if 0
		if ((bytes != -1) && !op_val(b, asm_vax[tst].width)) {
			char	*s;

			switch (asm_vax[tst].ifp) {
			case IFP_INT:	s = "int";  break;
			case IFP_F:	s = "F";    break;
			case IFP_D:	s = "D";    break;
			case IFP_G:	s = "G";    break;
			case IFP_H:	s = "H";    break;
			}

			printf("%3d/%3d: %2d %3s  |%s|                          *** killed by op_val()\n",
				tst, (int) ARRAY_SIZE(asm_vax), asm_vax[tst].width, s, asm_vax[tst].str);
		}
#endif

		/* did the test pass? */
		bool	testok = true;
		if (asm_vax[tst].cnt == -1) {
			/* was not supposed to parse/be a valid operand */
			if (valid)
				testok = false;
		} else {
			if (asm_vax[tst].cnt != bytes)
				testok = false;
			else {
				for (int i=0; i < bytes; i++)
					if (asm_vax[tst].b[i] != b[i]) {
						testok = false;
						break;
					}
			}
		}

		/* stats/output for the test*/
		pass_cnt += !!testok;

		if (!testok) {
			char	*s;

			switch (asm_vax[tst].ifp) {
			case IFP_INT:	s = "int";  break;
			case IFP_F:	s = "F";    break;
			case IFP_D:	s = "D";    break;
			case IFP_G:	s = "G";    break;
			case IFP_H:	s = "H";    break;
			default:
				UNREACHABLE();
			}

			printf("%3d/%3d: %2d %3s  |%s| \n", tst, (int) ARRAY_SIZE(asm_vax),
				asm_vax[tst].width, s, asm_vax[tst].str);

			printf("%12sexp:  ", "");
			for (int i=0; i < asm_vax[tst].cnt; i++) {
				if (i > 0)
					printf(" ");

				if ((i >= bytes) || (asm_vax[tst].b[i] != b[i]))
					printf("%s", GREEN);
				printf("%02X", asm_vax[tst].b[i]);
				if ((i >= bytes) || (asm_vax[tst].b[i] != b[i]))
					printf("%s", NORM);
			}
			if (asm_vax[tst].cnt == -1)
				printf("--");
			printf("\n");

			printf("%12sgot:  ", "");
			for (int i=0; i < bytes; i++) {
				if (i > 0)
					printf(" ");

				if ((i >= asm_vax[tst].cnt) || (asm_vax[tst].b[i] != b[i]))
					printf("%s", BOLD);
				printf("%02X", b[i]);
				if ((i >= asm_vax[tst].cnt) || (asm_vax[tst].b[i] != b[i]))
					printf("%s", NORM);
			}
			if (bytes == -1) {
				if (asm_vax[tst].cnt != -1)
					printf("%s", BOLD);
				printf("--");
				if (asm_vax[tst].cnt != -1)
					printf("%s", NORM);
			}
			printf("\n");
			printf("\n");
		}

	}

	printf("%3d/%3d tests passed.\n", pass_cnt, (int) ARRAY_SIZE(asm_vax));
	printf("\n");
}


/***/

struct test_dis_case {
	int	cnt;
	uint8_t	b[MAX_OPLEN];
	int	width;
	enum ifp ifp;
	char	*str;
};


struct test_dis_case dis_vax[] = {
	/* lit6, integers */
	{.cnt=1, .b={0x00}, .width=1, .ifp=IFP_INT, .str="S^#0x00"},
	{.cnt=1, .b={0x01}, .width=1, .ifp=IFP_INT, .str="S^#0x01"},
	{.cnt=1, .b={0x3F}, .width=1, .ifp=IFP_INT, .str="S^#0x3F"},

	/* lit6, floats */
	/* 000.000 */
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width=16, .ifp=IFP_H},

	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width=16, .ifp=IFP_H},

	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width=16, .ifp=IFP_H},

	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width=16, .ifp=IFP_H},

	/* 000.100 */
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width=16, .ifp=IFP_H},

	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width=16, .ifp=IFP_H},

	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width=16, .ifp=IFP_H},

	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width=16, .ifp=IFP_H},

	/* 001.000 */
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 4, .ifp=IFP_F},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 8, .ifp=IFP_D},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 8, .ifp=IFP_G},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width=16, .ifp=IFP_H},

	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width=16, .ifp=IFP_H},

	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width=16, .ifp=IFP_H},

	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width=16, .ifp=IFP_H},

	/* 001.100 */
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width=16, .ifp=IFP_H},

	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width=16, .ifp=IFP_H},

	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width=16, .ifp=IFP_H},

	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width=16, .ifp=IFP_H},

	/* 010.000 */
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 4, .ifp=IFP_F},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 8, .ifp=IFP_D},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 8, .ifp=IFP_G},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width=16, .ifp=IFP_H},

	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width=16, .ifp=IFP_H},

	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width=16, .ifp=IFP_H},

	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width=16, .ifp=IFP_H},

	/* 010.100 */
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 4, .ifp=IFP_F},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 8, .ifp=IFP_D},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 8, .ifp=IFP_G},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width=16, .ifp=IFP_H},

	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width=16, .ifp=IFP_H},

	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width=16, .ifp=IFP_H},

	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width=16, .ifp=IFP_H},

	/* 011.000 */
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 4, .ifp=IFP_F},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 8, .ifp=IFP_D},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 8, .ifp=IFP_G},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width=16, .ifp=IFP_H},

	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 4, .ifp=IFP_F},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 8, .ifp=IFP_D},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 8, .ifp=IFP_G},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width=16, .ifp=IFP_H},

	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 4, .ifp=IFP_F},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 8, .ifp=IFP_D},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 8, .ifp=IFP_G},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width=16, .ifp=IFP_H},

	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 4, .ifp=IFP_F},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 8, .ifp=IFP_D},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 8, .ifp=IFP_G},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width=16, .ifp=IFP_H},

	/* 011.100 */
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 4, .ifp=IFP_F},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 8, .ifp=IFP_D},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 8, .ifp=IFP_G},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width=16, .ifp=IFP_H},

	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 4, .ifp=IFP_F},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 8, .ifp=IFP_D},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 8, .ifp=IFP_G},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width=16, .ifp=IFP_H},

	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 4, .ifp=IFP_F},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 8, .ifp=IFP_D},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 8, .ifp=IFP_G},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width=16, .ifp=IFP_H},

	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 4, .ifp=IFP_F},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 8, .ifp=IFP_D},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 8, .ifp=IFP_G},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width=16, .ifp=IFP_H},

	/* 100.000 */
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 4, .ifp=IFP_F},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 8, .ifp=IFP_D},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 8, .ifp=IFP_G},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width=16, .ifp=IFP_H},

	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 4, .ifp=IFP_F},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 8, .ifp=IFP_D},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 8, .ifp=IFP_G},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width=16, .ifp=IFP_H},

	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 4, .ifp=IFP_F},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 8, .ifp=IFP_D},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 8, .ifp=IFP_G},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width=16, .ifp=IFP_H},

	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 4, .ifp=IFP_F},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 8, .ifp=IFP_D},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 8, .ifp=IFP_G},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width=16, .ifp=IFP_H},

	/* 100.100 */
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 4, .ifp=IFP_F},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 8, .ifp=IFP_D},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 8, .ifp=IFP_G},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width=16, .ifp=IFP_H},

	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 4, .ifp=IFP_F},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 8, .ifp=IFP_D},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 8, .ifp=IFP_G},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width=16, .ifp=IFP_H},

	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 4, .ifp=IFP_F},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 8, .ifp=IFP_D},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 8, .ifp=IFP_G},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width=16, .ifp=IFP_H},

	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 4, .ifp=IFP_F},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 8, .ifp=IFP_D},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 8, .ifp=IFP_G},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width=16, .ifp=IFP_H},

	/* 101.000 */
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 4, .ifp=IFP_F},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 8, .ifp=IFP_D},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 8, .ifp=IFP_G},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width=16, .ifp=IFP_H},

	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 4, .ifp=IFP_F},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 8, .ifp=IFP_D},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 8, .ifp=IFP_G},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width=16, .ifp=IFP_H},

	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 4, .ifp=IFP_F},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 8, .ifp=IFP_D},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 8, .ifp=IFP_G},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width=16, .ifp=IFP_H},

	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 4, .ifp=IFP_F},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 8, .ifp=IFP_D},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 8, .ifp=IFP_G},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width=16, .ifp=IFP_H},

	/* 101.100 */
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 4, .ifp=IFP_F},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 8, .ifp=IFP_D},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 8, .ifp=IFP_G},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width=16, .ifp=IFP_H},

	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 4, .ifp=IFP_F},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 8, .ifp=IFP_D},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 8, .ifp=IFP_G},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width=16, .ifp=IFP_H},

	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 4, .ifp=IFP_F},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 8, .ifp=IFP_D},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 8, .ifp=IFP_G},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width=16, .ifp=IFP_H},

	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 4, .ifp=IFP_F},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 8, .ifp=IFP_D},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 8, .ifp=IFP_G},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width=16, .ifp=IFP_H},

	/* 110.000 */
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 4, .ifp=IFP_F},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 8, .ifp=IFP_D},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 8, .ifp=IFP_G},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width=16, .ifp=IFP_H},

	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 4, .ifp=IFP_F},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 8, .ifp=IFP_D},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 8, .ifp=IFP_G},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width=16, .ifp=IFP_H},

	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 4, .ifp=IFP_F},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 8, .ifp=IFP_D},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 8, .ifp=IFP_G},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width=16, .ifp=IFP_H},

	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 4, .ifp=IFP_F},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 8, .ifp=IFP_D},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 8, .ifp=IFP_G},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width=16, .ifp=IFP_H},

	/* 110.100 */
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 4, .ifp=IFP_F},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 8, .ifp=IFP_D},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 8, .ifp=IFP_G},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width=16, .ifp=IFP_H},

	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 4, .ifp=IFP_F},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 8, .ifp=IFP_D},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 8, .ifp=IFP_G},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width=16, .ifp=IFP_H},

	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 4, .ifp=IFP_F},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 8, .ifp=IFP_D},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 8, .ifp=IFP_G},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width=16, .ifp=IFP_H},

	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 4, .ifp=IFP_F},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 8, .ifp=IFP_D},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 8, .ifp=IFP_G},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width=16, .ifp=IFP_H},

	/* 111.000 */
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 4, .ifp=IFP_F},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 8, .ifp=IFP_D},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 8, .ifp=IFP_G},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width=16, .ifp=IFP_H},

	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 4, .ifp=IFP_F},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 8, .ifp=IFP_D},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 8, .ifp=IFP_G},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width=16, .ifp=IFP_H},

	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 4, .ifp=IFP_F},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 8, .ifp=IFP_D},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 8, .ifp=IFP_G},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width=16, .ifp=IFP_H},

	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 4, .ifp=IFP_F},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 8, .ifp=IFP_D},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 8, .ifp=IFP_G},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width=16, .ifp=IFP_H},

	/* 111.100 */
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 4, .ifp=IFP_F},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 8, .ifp=IFP_D},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 8, .ifp=IFP_G},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width=16, .ifp=IFP_H},

	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 4, .ifp=IFP_F},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 8, .ifp=IFP_D},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 8, .ifp=IFP_G},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width=16, .ifp=IFP_H},

	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 4, .ifp=IFP_F},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 8, .ifp=IFP_D},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 8, .ifp=IFP_G},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width=16, .ifp=IFP_H},

	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 4, .ifp=IFP_F},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 8, .ifp=IFP_D},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 8, .ifp=IFP_G},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width=16, .ifp=IFP_H},


	/* big immediates, integers */

	{.str="I^#0x00",	.cnt=2, .b={0x8F, 0x00},	.width=1, .ifp=IFP_INT},
	{.str="I^#0x6A",	.cnt=2, .b={0x8F, 0x6A},	.width=1, .ifp=IFP_INT},
	{.str="I^#0xFF",	.cnt=2, .b={0x8F, 0xFF},	.width=1, .ifp=IFP_INT},

	{.str="I^#0x0000",	.cnt=3, .b={0x8F, 0x00,0x00},	.width=2, .ifp=IFP_INT},
	{.str="I^#0x00FF",	.cnt=3, .b={0x8F, 0xFF,0x00},	.width=2, .ifp=IFP_INT},
	{.str="I^#0x126A",	.cnt=3, .b={0x8F, 0x6A,0x12},	.width=2, .ifp=IFP_INT},
	{.str="I^#0xFFFF",	.cnt=3, .b={0x8F, 0xFF,0xFF},	.width=2, .ifp=IFP_INT},

	{.str="I^#0x0000_0000",	.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00},	.width=4, .ifp=IFP_INT},
	{.str="I^#0x0000_00FF",	.cnt=5, .b={0x8F, 0xFF,0x00,0x00,0x00},	.width=4, .ifp=IFP_INT},
	{.str="I^#0x1234_5678",	.cnt=5, .b={0x8F, 0x78,0x56,0x34,0x12},	.width=4, .ifp=IFP_INT},
	{.str="I^#0xFFFF_FFFF",	.cnt=5, .b={0x8F, 0xFF,0xFF,0xFF,0xFF},	.width=4, .ifp=IFP_INT},

	{.str="I^#0x0000_0000_0000_0000",
				.cnt=9, .b={0x8F, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00}, .width=8, .ifp=IFP_INT},
	{.str="I^#0x0000_0000_0000_00FF",
				.cnt=9, .b={0x8F, 0xFF,0x00,0x00,0x00, 0x00,0x00,0x00,0x00}, .width=8, .ifp=IFP_INT},
	{.str="I^#0x1234_5678_9ABC_DEF0",
				.cnt=9, .b={0x8F, 0xF0,0xDE,0xBC,0x9A, 0x78,0x56,0x34,0x12}, .width=8, .ifp=IFP_INT},
	{.str="I^#0xFFFF_FFFF_FFFF_FFFF",
				.cnt=9, .b={0x8F, 0xFF,0xFF,0xFF,0xFF, 0xFF,0xFF,0xFF,0xFF},.width=8, .ifp=IFP_INT},

	{.str="I^#0x0000_0000_0000_0000__0000_0000_0000_0000",
				.cnt=17, .b={0x8F, 0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00},.width=16, .ifp=IFP_INT},
	{.str="I^#0x0000_0000_0000_0000__0000_0000_0000_00FF",
				.cnt=17, .b={0x8F, 0xFF,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00},.width=16, .ifp=IFP_INT},
	{.str="I^#0xFEDC_BA98_7654_3210__0123_4567_89AB_CDEF",
				.cnt=17, .b={0x8F, 0xEF,0xCD,0xAB,0x89,
	                                           0x67,0x45,0x23,0x01,
	                                           0x10,0x32,0x54,0x76,
	                                           0x98,0xBA,0xDC,0xFE},.width=16, .ifp=IFP_INT},
	{.str="I^#0xFFFF_FFFF_FFFF_FFFF__FFFF_FFFF_FFFF_FFFF",
				.cnt=17, .b={0x8F, 0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF},.width=16, .ifp=IFP_INT},

	/* big immediates, fp values */

	{.str="I^#0",		.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#1",		.cnt=5, .b={0x8F, 0x80,0x40,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.1",		.cnt=5, .b={0x8F, 0x8C,0x40,0xCD,0xCC}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.1415",	.cnt=5, .b={0x8F, 0x92,0x40,0xAC,0x1C}, .width= 4, .ifp=IFP_F},
	{.str="I^#123.1",	.cnt=5, .b={0x8F, 0xF6,0x43,0x33,0x33}, .width= 4, .ifp=IFP_F},
	{.str="I^#-123.1",	.cnt=5, .b={0x8F, 0xF6,0xC3,0x33,0x33}, .width= 4, .ifp=IFP_F},
	{.str="I^#123100",	.cnt=5, .b={0x8F, 0xF0,0x48,0x00,0x6E}, .width= 4, .ifp=IFP_F},
	{.str="I^#0.1231",	.cnt=5, .b={0x8F, 0xFC,0x3E,0xDA,0x1B}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.231E14",	.cnt=5, .b={0x8F, 0xDF,0x57,0xE8,0xEA}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.231E-10",	.cnt=5, .b={0x8F, 0x07,0x30,0x92,0x59}, .width= 4, .ifp=IFP_F},

	{.str="I^#1.231E-10",	.cnt=9, .b={0x8F, 0x07,0x30,0x91,0x59, 0x79,0xD3,0xDA,0x40}, .width= 8, .ifp=IFP_D},
	{.str="I^#1.231E-10",	.cnt=9, .b={0x8F, 0x00,0x3E,0x32,0xEB, 0x6F,0x3A,0x1B,0x28}, .width= 8, .ifp=IFP_G},
	{.str="I^#1.231E-121",	.cnt=17,.b={0x8F, 0x6F,0x3E,0x81,0x45,
	                                          0x75,0x03,0x54,0x8A,
	                                          0x39,0xD5,0x0A,0x5C,
	                                          0xD7,0x79,0x8F,0xDE}, .width=16, .ifp=IFP_H},

	/***/


	{.str="r0",		.cnt=1, .b={0x50}, .width=1, .ifp=IFP_INT},
	{.str="r4",		.cnt=1, .b={0x54}, .width=1, .ifp=IFP_INT},
	{.str="fp",		.cnt=1, .b={0x5D}, .width=1, .ifp=IFP_INT},
	{.str="sp",		.cnt=1, .b={0x5F}, .width=1, .ifp=IFP_INT},

	{.str="(r0)",		.cnt=1, .b={0x60}, .width=1, .ifp=IFP_INT},
	{.str="(fp)",		.cnt=1, .b={0x6D}, .width=1, .ifp=IFP_INT},
	{.str="(pc)",		.cnt=1, .b={0x6F}, .width=1, .ifp=IFP_INT},

	{.str="-(r0)",		.cnt=1, .b={0x70}, .width=1, .ifp=IFP_INT},
	{.str="-(fp)",		.cnt=1, .b={0x7D}, .width=1, .ifp=IFP_INT},
	{.str="-(pc)",		.cnt=1, .b={0x7F}, .width=1, .ifp=IFP_INT},

	{.str="(r2)+",		.cnt=1, .b={0x82}, .width=1, .ifp=IFP_INT},
	{.str="(ap)+",		.cnt=1, .b={0x8C}, .width=1, .ifp=IFP_INT},

	{.str="@#0x1234_5678",	.cnt=5, .b={0x9F, 0x78,0x56,0x34,0x12}, .width=1, .ifp=IFP_INT},

	{.str="@(r0)+",		.cnt=1, .b={0x90}, .width=1, .ifp=IFP_INT},
	{.str="@(fp)+",		.cnt=1, .b={0x9D}, .width=1, .ifp=IFP_INT},

	/* pcrel/disp */
	{.str="B^0xCAFE_BB00",	.cnt=2, .b={0xAF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="B^100(fp)",	.cnt=2, .b={0xAD, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^0xCAFE_BB00",	.cnt=2, .b={0xBF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(fp)",	.cnt=2, .b={0xBD, 0x64}, .width=1, .ifp=IFP_INT},

	{.str="W^0xCAFE_C000",	.cnt=3, .b={0xCF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="W^1000(fp)",	.cnt=3, .b={0xCD, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^0xCAFE_C000",	.cnt=3, .b={0xDF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(fp)",	.cnt=3, .b={0xDD, 0xE8,0x03}, .width=1, .ifp=IFP_INT},

	{.str="L^0xCC00_C000",	.cnt=5, .b={0xEF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="L^100000(fp)",	.cnt=5, .b={0xED, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^0xCC00_C000",	.cnt=5, .b={0xFF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(fp)",	.cnt=5, .b={0xFD, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},


	/* indexed operands (some of he combinations here are illegal) */
	{.str="(r2)[fp]",		.cnt=2, .b={0x4D,0x62}, .width=1, .ifp=IFP_INT},
	{.str="(pc)[fp]",		.cnt=2, .b={0x4D,0x6F}, .width=1, .ifp=IFP_INT},
	{.str="(r2)[pc]",		.cnt=2, .b={0x4F,0x62}, .width=1, .ifp=IFP_INT},
	{.str="-(r2)[fp]",		.cnt=2, .b={0x4D,0x72}, .width=1, .ifp=IFP_INT},
	{.str="(r2)+[fp]",		.cnt=2, .b={0x4D,0x82}, .width=1, .ifp=IFP_INT},
	{.str="@#0x1234_5678[fp]",	.cnt=6, .b={0x4D,0x9F, 0x78,0x56,0x34,0x12}, .width=1, .ifp=IFP_INT},
	{.str="@(r2)+[fp]",		.cnt=2, .b={0x4D,0x92}, .width=1, .ifp=IFP_INT},


	{.str="B^0xCAFE_BB00[fp]",	.cnt=3, .b={0x4D,0xAF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="B^100(r2)[fp]",		.cnt=3, .b={0x4D,0xA2, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^^XCAFE_BB00[fp]",	.cnt=3, .b={0x4D,0xBF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(r2)[fp]",		.cnt=3, .b={0x4D,0xB2, 0x64}, .width=1, .ifp=IFP_INT},

	{.str="W^0xCAFE_C000[fp]",	.cnt=4, .b={0x4D,0xCF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="W^1000(r2)[fp]",		.cnt=4, .b={0x4D,0xC2, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^0xCAFE_C000[fp]",	.cnt=4, .b={0x4D,0xDF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(r2)[fp]",	.cnt=4, .b={0x4D,0xD2, 0xE8,0x03}, .width=1, .ifp=IFP_INT},

	{.str="L^0xCC00_C000[fp]",	.cnt=6, .b={0x4D,0xEF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="L^100000(r2)[fp]",	.cnt=6, .b={0x4D,0xE2, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^0xCC00_C000[fp]",	.cnt=6, .b={0x4D,0xFF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(r2)[fp]",	.cnt=6, .b={0x4D,0xF2, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},

};

/***/

void dis_run(struct test_dis_case test)
{
	struct dis_ret dis_ret = op_dis_vax(test.b, 0xCAFEBABE, test.width, test.ifp);

	for (int i=0; i < (int) sizeof(test.b); i++) {
		if (i < test.cnt)
			printf("%02X ", test.b[i]);
		else
			printf("   ");
	}

	printf("%2d ", test.width);
	switch (test.ifp) {
	case IFP_INT:	printf("  "); break;
	case IFP_F:	printf("f "); break;
	case IFP_D:	printf("d "); break;
	case IFP_G:	printf("g "); break;
	case IFP_H:	printf("h "); break;
	default:
		UNREACHABLE();
	}

	if (dis_ret.cnt == -1)
		printf("%-9s", "-");
	else {
		assert((dis_ret.cnt >= 1) && (dis_ret.cnt <= (int) sizeof(test.b)));

		for (int i=0; i < (int) sizeof(test.b); i++)
			printf("%c", (i < dis_ret.cnt) ? 'x' : ' ');
	}

	printf(" ");
	if (dis_ret.cnt != -1) {
		printf("%s", dis_ret.str);
	} else {
		printf("-");
	}
	printf("\n");
}


void test_dis()
{
	printf("Disassembly\n");
	printf("-----------\n");
	for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++)
		dis_run(dis_vax[i]);

	printf("\n");
}

/***/

struct test_sim_case {
	int	cnt;
	uint8_t	b[MAX_OPLEN];
	int	width;
	enum ifp ifp;
	char	*str;
};


struct test_sim_case sim_vax[] = {
	/* lit6, integers */
	{.cnt=1, .b={0x00}, .width=1, .ifp=IFP_INT, .str="S^#0x00"},
	{.cnt=1, .b={0x01}, .width=1, .ifp=IFP_INT, .str="S^#0x01"},
	{.cnt=1, .b={0x3F}, .width=1, .ifp=IFP_INT, .str="S^#0x3F"},

	/* lit6, floats */
	/* 000.000 */
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.5",		.cnt=1, .b={0x00}, .width=16, .ifp=IFP_H},

	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.5625",	.cnt=1, .b={0x01}, .width=16, .ifp=IFP_H},

	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.625",	.cnt=1, .b={0x02}, .width=16, .ifp=IFP_H},

	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.6875",	.cnt=1, .b={0x03}, .width=16, .ifp=IFP_H},

	/* 000.100 */
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.75",	.cnt=1, .b={0x04}, .width=16, .ifp=IFP_H},

	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.8125",	.cnt=1, .b={0x05}, .width=16, .ifp=IFP_H},

	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.875",	.cnt=1, .b={0x06}, .width=16, .ifp=IFP_H},

	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 4, .ifp=IFP_F},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 8, .ifp=IFP_D},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width= 8, .ifp=IFP_G},
	{.str="S^#0.9375",	.cnt=1, .b={0x07}, .width=16, .ifp=IFP_H},

	/* 001.000 */
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 4, .ifp=IFP_F},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 8, .ifp=IFP_D},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width= 8, .ifp=IFP_G},
	{.str="S^#1",		.cnt=1, .b={0x08}, .width=16, .ifp=IFP_H},

	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.125",	.cnt=1, .b={0x09}, .width=16, .ifp=IFP_H},

	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.25",	.cnt=1, .b={0x0A}, .width=16, .ifp=IFP_H},

	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.375",	.cnt=1, .b={0x0B}, .width=16, .ifp=IFP_H},

	/* 001.100 */
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.5",		.cnt=1, .b={0x0C}, .width=16, .ifp=IFP_H},

	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.625",	.cnt=1, .b={0x0D}, .width=16, .ifp=IFP_H},

	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.75",	.cnt=1, .b={0x0E}, .width=16, .ifp=IFP_H},

	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 4, .ifp=IFP_F},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 8, .ifp=IFP_D},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width= 8, .ifp=IFP_G},
	{.str="S^#1.875",	.cnt=1, .b={0x0F}, .width=16, .ifp=IFP_H},

	/* 010.000 */
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 4, .ifp=IFP_F},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 8, .ifp=IFP_D},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width= 8, .ifp=IFP_G},
	{.str="S^#2",		.cnt=1, .b={0x10}, .width=16, .ifp=IFP_H},

	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.25",	.cnt=1, .b={0x11}, .width=16, .ifp=IFP_H},

	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.5",		.cnt=1, .b={0x12}, .width=16, .ifp=IFP_H},

	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 4, .ifp=IFP_F},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 8, .ifp=IFP_D},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width= 8, .ifp=IFP_G},
	{.str="S^#2.75",	.cnt=1, .b={0x13}, .width=16, .ifp=IFP_H},

	/* 010.100 */
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 4, .ifp=IFP_F},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 8, .ifp=IFP_D},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width= 8, .ifp=IFP_G},
	{.str="S^#3",		.cnt=1, .b={0x14}, .width=16, .ifp=IFP_H},

	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.25",	.cnt=1, .b={0x15}, .width=16, .ifp=IFP_H},

	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.5",		.cnt=1, .b={0x16}, .width=16, .ifp=IFP_H},

	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 4, .ifp=IFP_F},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 8, .ifp=IFP_D},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width= 8, .ifp=IFP_G},
	{.str="S^#3.75",	.cnt=1, .b={0x17}, .width=16, .ifp=IFP_H},

	/* 011.000 */
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 4, .ifp=IFP_F},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 8, .ifp=IFP_D},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width= 8, .ifp=IFP_G},
	{.str="S^#4",		.cnt=1, .b={0x18}, .width=16, .ifp=IFP_H},

	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 4, .ifp=IFP_F},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 8, .ifp=IFP_D},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width= 8, .ifp=IFP_G},
	{.str="S^#4.5",		.cnt=1, .b={0x19}, .width=16, .ifp=IFP_H},

	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 4, .ifp=IFP_F},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 8, .ifp=IFP_D},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width= 8, .ifp=IFP_G},
	{.str="S^#5",		.cnt=1, .b={0x1A}, .width=16, .ifp=IFP_H},

	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 4, .ifp=IFP_F},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 8, .ifp=IFP_D},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width= 8, .ifp=IFP_G},
	{.str="S^#5.5",		.cnt=1, .b={0x1B}, .width=16, .ifp=IFP_H},

	/* 011.100 */
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 4, .ifp=IFP_F},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 8, .ifp=IFP_D},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width= 8, .ifp=IFP_G},
	{.str="S^#6",		.cnt=1, .b={0x1C}, .width=16, .ifp=IFP_H},

	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 4, .ifp=IFP_F},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 8, .ifp=IFP_D},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width= 8, .ifp=IFP_G},
	{.str="S^#6.5",		.cnt=1, .b={0x1D}, .width=16, .ifp=IFP_H},

	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 4, .ifp=IFP_F},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 8, .ifp=IFP_D},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width= 8, .ifp=IFP_G},
	{.str="S^#7",		.cnt=1, .b={0x1E}, .width=16, .ifp=IFP_H},

	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 4, .ifp=IFP_F},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 8, .ifp=IFP_D},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width= 8, .ifp=IFP_G},
	{.str="S^#7.5",		.cnt=1, .b={0x1F}, .width=16, .ifp=IFP_H},

	/* 100.000 */
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 4, .ifp=IFP_F},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 8, .ifp=IFP_D},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width= 8, .ifp=IFP_G},
	{.str="S^#8",		.cnt=1, .b={0x20}, .width=16, .ifp=IFP_H},

	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 4, .ifp=IFP_F},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 8, .ifp=IFP_D},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width= 8, .ifp=IFP_G},
	{.str="S^#9",		.cnt=1, .b={0x21}, .width=16, .ifp=IFP_H},

	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 4, .ifp=IFP_F},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 8, .ifp=IFP_D},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width= 8, .ifp=IFP_G},
	{.str="S^#10",		.cnt=1, .b={0x22}, .width=16, .ifp=IFP_H},

	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 4, .ifp=IFP_F},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 8, .ifp=IFP_D},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width= 8, .ifp=IFP_G},
	{.str="S^#11",		.cnt=1, .b={0x23}, .width=16, .ifp=IFP_H},

	/* 100.100 */
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 4, .ifp=IFP_F},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 8, .ifp=IFP_D},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width= 8, .ifp=IFP_G},
	{.str="S^#12",		.cnt=1, .b={0x24}, .width=16, .ifp=IFP_H},

	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 4, .ifp=IFP_F},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 8, .ifp=IFP_D},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width= 8, .ifp=IFP_G},
	{.str="S^#13",		.cnt=1, .b={0x25}, .width=16, .ifp=IFP_H},

	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 4, .ifp=IFP_F},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 8, .ifp=IFP_D},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width= 8, .ifp=IFP_G},
	{.str="S^#14",		.cnt=1, .b={0x26}, .width=16, .ifp=IFP_H},

	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 4, .ifp=IFP_F},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 8, .ifp=IFP_D},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width= 8, .ifp=IFP_G},
	{.str="S^#15",		.cnt=1, .b={0x27}, .width=16, .ifp=IFP_H},

	/* 101.000 */
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 4, .ifp=IFP_F},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 8, .ifp=IFP_D},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width= 8, .ifp=IFP_G},
	{.str="S^#16",		.cnt=1, .b={0x28}, .width=16, .ifp=IFP_H},

	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 4, .ifp=IFP_F},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 8, .ifp=IFP_D},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width= 8, .ifp=IFP_G},
	{.str="S^#18",		.cnt=1, .b={0x29}, .width=16, .ifp=IFP_H},

	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 4, .ifp=IFP_F},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 8, .ifp=IFP_D},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width= 8, .ifp=IFP_G},
	{.str="S^#20",		.cnt=1, .b={0x2A}, .width=16, .ifp=IFP_H},

	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 4, .ifp=IFP_F},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 8, .ifp=IFP_D},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width= 8, .ifp=IFP_G},
	{.str="S^#22",		.cnt=1, .b={0x2B}, .width=16, .ifp=IFP_H},

	/* 101.100 */
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 4, .ifp=IFP_F},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 8, .ifp=IFP_D},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width= 8, .ifp=IFP_G},
	{.str="S^#24",		.cnt=1, .b={0x2C}, .width=16, .ifp=IFP_H},

	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 4, .ifp=IFP_F},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 8, .ifp=IFP_D},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width= 8, .ifp=IFP_G},
	{.str="S^#26",		.cnt=1, .b={0x2D}, .width=16, .ifp=IFP_H},

	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 4, .ifp=IFP_F},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 8, .ifp=IFP_D},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width= 8, .ifp=IFP_G},
	{.str="S^#28",		.cnt=1, .b={0x2E}, .width=16, .ifp=IFP_H},

	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 4, .ifp=IFP_F},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 8, .ifp=IFP_D},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width= 8, .ifp=IFP_G},
	{.str="S^#30",		.cnt=1, .b={0x2F}, .width=16, .ifp=IFP_H},

	/* 110.000 */
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 4, .ifp=IFP_F},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 8, .ifp=IFP_D},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width= 8, .ifp=IFP_G},
	{.str="S^#32",		.cnt=1, .b={0x30}, .width=16, .ifp=IFP_H},

	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 4, .ifp=IFP_F},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 8, .ifp=IFP_D},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width= 8, .ifp=IFP_G},
	{.str="S^#36",		.cnt=1, .b={0x31}, .width=16, .ifp=IFP_H},

	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 4, .ifp=IFP_F},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 8, .ifp=IFP_D},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width= 8, .ifp=IFP_G},
	{.str="S^#40",		.cnt=1, .b={0x32}, .width=16, .ifp=IFP_H},

	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 4, .ifp=IFP_F},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 8, .ifp=IFP_D},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width= 8, .ifp=IFP_G},
	{.str="S^#44",		.cnt=1, .b={0x33}, .width=16, .ifp=IFP_H},

	/* 110.100 */
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 4, .ifp=IFP_F},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 8, .ifp=IFP_D},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width= 8, .ifp=IFP_G},
	{.str="S^#48",		.cnt=1, .b={0x34}, .width=16, .ifp=IFP_H},

	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 4, .ifp=IFP_F},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 8, .ifp=IFP_D},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width= 8, .ifp=IFP_G},
	{.str="S^#52",		.cnt=1, .b={0x35}, .width=16, .ifp=IFP_H},

	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 4, .ifp=IFP_F},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 8, .ifp=IFP_D},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width= 8, .ifp=IFP_G},
	{.str="S^#56",		.cnt=1, .b={0x36}, .width=16, .ifp=IFP_H},

	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 4, .ifp=IFP_F},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 8, .ifp=IFP_D},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width= 8, .ifp=IFP_G},
	{.str="S^#60",		.cnt=1, .b={0x37}, .width=16, .ifp=IFP_H},

	/* 111.000 */
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 4, .ifp=IFP_F},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 8, .ifp=IFP_D},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width= 8, .ifp=IFP_G},
	{.str="S^#64",		.cnt=1, .b={0x38}, .width=16, .ifp=IFP_H},

	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 4, .ifp=IFP_F},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 8, .ifp=IFP_D},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width= 8, .ifp=IFP_G},
	{.str="S^#72",		.cnt=1, .b={0x39}, .width=16, .ifp=IFP_H},

	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 4, .ifp=IFP_F},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 8, .ifp=IFP_D},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width= 8, .ifp=IFP_G},
	{.str="S^#80",		.cnt=1, .b={0x3A}, .width=16, .ifp=IFP_H},

	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 4, .ifp=IFP_F},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 8, .ifp=IFP_D},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width= 8, .ifp=IFP_G},
	{.str="S^#88",		.cnt=1, .b={0x3B}, .width=16, .ifp=IFP_H},

	/* 111.100 */
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 4, .ifp=IFP_F},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 8, .ifp=IFP_D},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width= 8, .ifp=IFP_G},
	{.str="S^#96",		.cnt=1, .b={0x3C}, .width=16, .ifp=IFP_H},

	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 4, .ifp=IFP_F},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 8, .ifp=IFP_D},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width= 8, .ifp=IFP_G},
	{.str="S^#104",		.cnt=1, .b={0x3D}, .width=16, .ifp=IFP_H},

	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 4, .ifp=IFP_F},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 8, .ifp=IFP_D},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width= 8, .ifp=IFP_G},
	{.str="S^#112",		.cnt=1, .b={0x3E}, .width=16, .ifp=IFP_H},

	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 4, .ifp=IFP_F},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 8, .ifp=IFP_D},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width= 8, .ifp=IFP_G},
	{.str="S^#120",		.cnt=1, .b={0x3F}, .width=16, .ifp=IFP_H},


	/* big immediates, integers */

	{.str="I^#0x00",	.cnt=2, .b={0x8F, 0x00},	.width=1, .ifp=IFP_INT},
	{.str="I^#0x6A",	.cnt=2, .b={0x8F, 0x6A},	.width=1, .ifp=IFP_INT},
	{.str="I^#0xFF",	.cnt=2, .b={0x8F, 0xFF},	.width=1, .ifp=IFP_INT},

	{.str="I^#0x0000",	.cnt=3, .b={0x8F, 0x00,0x00},	.width=2, .ifp=IFP_INT},
	{.str="I^#0x00FF",	.cnt=3, .b={0x8F, 0xFF,0x00},	.width=2, .ifp=IFP_INT},
	{.str="I^#0x126A",	.cnt=3, .b={0x8F, 0x6A,0x12},	.width=2, .ifp=IFP_INT},
	{.str="I^#0xFFFF",	.cnt=3, .b={0x8F, 0xFF,0xFF},	.width=2, .ifp=IFP_INT},

	{.str="I^#0x0000_0000",	.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00},	.width=4, .ifp=IFP_INT},
	{.str="I^#0x0000_00FF",	.cnt=5, .b={0x8F, 0xFF,0x00,0x00,0x00},	.width=4, .ifp=IFP_INT},
	{.str="I^#0x1234_5678",	.cnt=5, .b={0x8F, 0x78,0x56,0x34,0x12},	.width=4, .ifp=IFP_INT},
	{.str="I^#0xFFFF_FFFF",	.cnt=5, .b={0x8F, 0xFF,0xFF,0xFF,0xFF},	.width=4, .ifp=IFP_INT},

	{.str="I^#0x0000_0000_0000_0000",
				.cnt=9, .b={0x8F, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00}, .width=8, .ifp=IFP_INT},
	{.str="I^#0x0000_0000_0000_00FF",
				.cnt=9, .b={0x8F, 0xFF,0x00,0x00,0x00, 0x00,0x00,0x00,0x00}, .width=8, .ifp=IFP_INT},
	{.str="I^#0x1234_5678_9ABC_DEF0",
				.cnt=9, .b={0x8F, 0xF0,0xDE,0xBC,0x9A, 0x78,0x56,0x34,0x12}, .width=8, .ifp=IFP_INT},
	{.str="I^#0xFFFF_FFFF_FFFF_FFFF",
				.cnt=9, .b={0x8F, 0xFF,0xFF,0xFF,0xFF, 0xFF,0xFF,0xFF,0xFF},.width=8, .ifp=IFP_INT},

	{.str="I^#0x0000_0000_0000_0000__0000_0000_0000_0000",
				.cnt=17, .b={0x8F, 0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00},.width=16, .ifp=IFP_INT},
	{.str="I^#0x0000_0000_0000_0000__0000_0000_0000_00FF",
				.cnt=17, .b={0x8F, 0xFF,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00,
	                                           0x00,0x00,0x00,0x00},.width=16, .ifp=IFP_INT},
	{.str="I^#0xFEDC_BA98_7654_3210__0123_4567_89AB_CDEF",
				.cnt=17, .b={0x8F, 0xEF,0xCD,0xAB,0x89,
	                                           0x67,0x45,0x23,0x01,
	                                           0x10,0x32,0x54,0x76,
	                                           0x98,0xBA,0xDC,0xFE},.width=16, .ifp=IFP_INT},
	{.str="I^#0xFFFF_FFFF_FFFF_FFFF__FFFF_FFFF_FFFF_FFFF",
				.cnt=17, .b={0x8F, 0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF,
				                   0xFF,0xFF,0xFF,0xFF},.width=16, .ifp=IFP_INT},

	/* big immediates, fp values */

	{.str="I^#0",		.cnt=5, .b={0x8F, 0x00,0x00,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#1",		.cnt=5, .b={0x8F, 0x80,0x40,0x00,0x00}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.1",		.cnt=5, .b={0x8F, 0x8C,0x40,0xCD,0xCC}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.1415",	.cnt=5, .b={0x8F, 0x92,0x40,0xAC,0x1C}, .width= 4, .ifp=IFP_F},
	{.str="I^#123.1",	.cnt=5, .b={0x8F, 0xF6,0x43,0x33,0x33}, .width= 4, .ifp=IFP_F},
	{.str="I^#-123.1",	.cnt=5, .b={0x8F, 0xF6,0xC3,0x33,0x33}, .width= 4, .ifp=IFP_F},
	{.str="I^#123100",	.cnt=5, .b={0x8F, 0xF0,0x48,0x00,0x6E}, .width= 4, .ifp=IFP_F},
	{.str="I^#0.1231",	.cnt=5, .b={0x8F, 0xFC,0x3E,0xDA,0x1B}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.231E14",	.cnt=5, .b={0x8F, 0xDF,0x57,0xE8,0xEA}, .width= 4, .ifp=IFP_F},
	{.str="I^#1.231E-10",	.cnt=5, .b={0x8F, 0x07,0x30,0x92,0x59}, .width= 4, .ifp=IFP_F},

	{.str="I^#1.231E-10",	.cnt=9, .b={0x8F, 0x07,0x30,0x91,0x59, 0x79,0xD3,0xDA,0x40}, .width= 8, .ifp=IFP_D},
	{.str="I^#1.231E-10",	.cnt=9, .b={0x8F, 0x00,0x3E,0x32,0xEB, 0x6F,0x3A,0x1B,0x28}, .width= 8, .ifp=IFP_G},
	{.str="I^#1.231E-121",	.cnt=17,.b={0x8F, 0x6F,0x3E,0x81,0x45,
	                                          0x75,0x03,0x54,0x8A,
	                                          0x39,0xD5,0x0A,0x5C,
	                                          0xD7,0x79,0x8F,0xDE}, .width=16, .ifp=IFP_H},

	/***/


	{.str="r0",		.cnt=1, .b={0x50}, .width=1, .ifp=IFP_INT},
	{.str="r4",		.cnt=1, .b={0x54}, .width=1, .ifp=IFP_INT},
	{.str="fp",		.cnt=1, .b={0x5D}, .width=1, .ifp=IFP_INT},
	{.str="sp",		.cnt=1, .b={0x5F}, .width=1, .ifp=IFP_INT},

	{.str="(r0)",		.cnt=1, .b={0x60}, .width=1, .ifp=IFP_INT},
	{.str="(fp)",		.cnt=1, .b={0x6D}, .width=1, .ifp=IFP_INT},
	{.str="(pc)",		.cnt=1, .b={0x6F}, .width=1, .ifp=IFP_INT},

	{.str="-(r0)",		.cnt=1, .b={0x70}, .width=1, .ifp=IFP_INT},
	{.str="-(fp)",		.cnt=1, .b={0x7D}, .width=1, .ifp=IFP_INT},
	{.str="-(pc)",		.cnt=1, .b={0x7F}, .width=1, .ifp=IFP_INT},

	{.str="(r2)+",		.cnt=1, .b={0x82}, .width=1, .ifp=IFP_INT},
	{.str="(ap)+",		.cnt=1, .b={0x8C}, .width=1, .ifp=IFP_INT},

	{.str="@#0x1234_5678",	.cnt=5, .b={0x9F, 0x78,0x56,0x34,0x12}, .width=1, .ifp=IFP_INT},

	{.str="@(r0)+",		.cnt=1, .b={0x90}, .width=1, .ifp=IFP_INT},
	{.str="@(fp)+",		.cnt=1, .b={0x9D}, .width=1, .ifp=IFP_INT},

	/* pcrel/disp */
	{.str="B^0xCAFE_BB00",	.cnt=2, .b={0xAF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="B^100(fp)",	.cnt=2, .b={0xAD, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^0xCAFE_BB00",	.cnt=2, .b={0xBF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(fp)",	.cnt=2, .b={0xBD, 0x64}, .width=1, .ifp=IFP_INT},

	{.str="W^0xCAFE_C000",	.cnt=3, .b={0xCF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="W^1000(fp)",	.cnt=3, .b={0xCD, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^0xCAFE_C000",	.cnt=3, .b={0xDF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(fp)",	.cnt=3, .b={0xDD, 0xE8,0x03}, .width=1, .ifp=IFP_INT},

	{.str="L^0xCC00_C000",	.cnt=5, .b={0xEF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="L^100000(fp)",	.cnt=5, .b={0xED, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^0xCC00_C000",	.cnt=5, .b={0xFF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(fp)",	.cnt=5, .b={0xFD, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},


	/* indexed operands (some of he combinations here are illegal) */
	{.str="(r2)[fp]",		.cnt=2, .b={0x4D,0x62}, .width=1, .ifp=IFP_INT},
	{.str="(pc)[fp]",		.cnt=2, .b={0x4D,0x6F}, .width=1, .ifp=IFP_INT},
	{.str="(r2)[pc]",		.cnt=2, .b={0x4F,0x62}, .width=1, .ifp=IFP_INT},
	{.str="-(r2)[fp]",		.cnt=2, .b={0x4D,0x72}, .width=1, .ifp=IFP_INT},
	{.str="(r2)+[fp]",		.cnt=2, .b={0x4D,0x82}, .width=1, .ifp=IFP_INT},
	{.str="@#0x1234_5678[fp]",	.cnt=6, .b={0x4D,0x9F, 0x78,0x56,0x34,0x12}, .width=1, .ifp=IFP_INT},
	{.str="@(r2)+[fp]",		.cnt=2, .b={0x4D,0x92}, .width=1, .ifp=IFP_INT},


	{.str="B^0xCAFE_BB00[fp]",	.cnt=3, .b={0x4D,0xAF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="B^100(r2)[fp]",		.cnt=3, .b={0x4D,0xA2, 0x64}, .width=1, .ifp=IFP_INT},
	{.str="@B^^XCAFE_BB00[fp]",	.cnt=3, .b={0x4D,0xBF, 0x42}, .width=1, .ifp=IFP_INT},
	{.str="@B^100(r2)[fp]",		.cnt=3, .b={0x4D,0xB2, 0x64}, .width=1, .ifp=IFP_INT},

	{.str="W^0xCAFE_C000[fp]",	.cnt=4, .b={0x4D,0xCF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="W^1000(r2)[fp]",		.cnt=4, .b={0x4D,0xC2, 0xE8,0x03}, .width=1, .ifp=IFP_INT},
	{.str="@W^0xCAFE_C000[fp]",	.cnt=4, .b={0x4D,0xDF, 0x42,0x05}, .width=1, .ifp=IFP_INT},
	{.str="@W^1000(r2)[fp]",	.cnt=4, .b={0x4D,0xD2, 0xE8,0x03}, .width=1, .ifp=IFP_INT},

	{.str="L^0xCC00_C000[fp]",	.cnt=6, .b={0x4D,0xEF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="L^100000(r2)[fp]",	.cnt=6, .b={0x4D,0xE2, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},
	{.str="@L^0xCC00_C000[fp]",	.cnt=6, .b={0x4D,0xFF, 0x42,0x05,0x02,0x01}, .width=1, .ifp=IFP_INT},
	{.str="@L^100000(r2)[fp]",	.cnt=6, .b={0x4D,0xF2, 0xA0,0x86,0x01,0x00}, .width=1, .ifp=IFP_INT},

};


void sim_run(struct test_dis_case test)
{
	assert((test.cnt >= 0) && (test.cnt <= (int) sizeof(test.b)));
	assert((test.width == 1) || (test.width == 2) || (test.width == 4) || (test.width == 8) || (test.width == 16));

	struct fields	fields;
	memset(&fields, 0xFF, sizeof(fields));

	struct sim_ret sim_ret = op_sim(test.b, &fields, test.width, test.ifp);

	for (int i=0; i < (int) sizeof(test.b); i++) {
		if (i < test.cnt)
			printf("%02X ", test.b[i]);
		else
			printf("   ");
	}

	printf("%2d ", test.width);
	switch (test.ifp) {
	case IFP_INT:	printf("  "); break;
	case IFP_F:	printf("f "); break;
	case IFP_D:	printf("d "); break;
	case IFP_G:	printf("g "); break;
	case IFP_H:	printf("h "); break;
	default:
		UNREACHABLE();
	}

	if (sim_ret.cnt == -1)
		printf("%-9s", "-");
	else {
		assert((sim_ret.cnt >= 1) && (sim_ret.cnt <= (int) sizeof(test.b)));

		for (int i=0; i < (int) sizeof(test.b); i++)
			printf("%c", (i < sim_ret.cnt) ? 'x' : ' ');
	}
	printf(" ");
	if (sim_ret.cnt == -1)
		printf("(");
	else
		printf(" ");
	switch (sim_ret.cl) {
	case CLASS_IMM:	printf("I    "); break;
	case CLASS_REG: printf("R    "); break;
	default:
		printf("M:%-3d", sim_ret.cl);
	}
	printf(" ");

	if (sim_ret.cnt == -1)
		printf("  ");	/* reserved-addr-mode --> ignore fields */
	else {
		if (test.cnt != sim_ret.cnt)
			printf("! ");	/* didn't parse the expected number of bytes */
		else
			printf("  ");
	}

	/* fields */
	if (fields.Rn != -1)
		printf("Rn=%d ", fields.Rn);
	if (fields.Rx != -1)
		printf("Rx=%d ", fields.Rx);
	if (fields.addr != -1)
		printf("addr=%04X_%04X ", SPLIT(fields.addr));
	if (fields.disp != -1)
		printf("disp=%04X_%04X ", SPLIT(fields.disp));
	if ((fields.imm.val[0] != (uint32_t) -1) || (fields.imm.val[1] != (uint32_t) -1)) {
		printf("imm[0]=%04X_%04X ", SPLIT(fields.imm.val[0]));
		if (fields.imm.val[1] != (uint32_t) -1)
			printf("imm[1]=%04X_%04X ", SPLIT(fields.imm.val[1]));
	}
	if (fields.lit6 != -1)
		printf("lit6=%02X ", fields.lit6);
	if (sim_ret.cnt == -1)
		printf(")");

	printf("\n");
}


void test_sim()
{
	printf("Simulator\n");
	printf("---------\n");
	for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++)
		sim_run(dis_vax[i]);

	printf("\n");
}


/***/

/* Crappy benchmarking of operand handling.

   The measurements are surprisingly unsteady :(

   I should probably switch to using something like a robust regression
   framework that throws out slow outliers + automatically figure out how many
   iterations to have of each benchmark for the benchmark itself to be slower
   than the clock_xxxx() housekeeping.

   I tried to make it nicer -- time_asm() is a relic of that -- but it doesn't
   help much.

   ---

   I should also try to benchmark each asm_vax/dis_vax testcase individually,
   so I know what is costly and what isn't.

 */


/* time difference in s */
double timediff(struct timespec from, struct timespec to)
{
	return (to.tv_sec - from.tv_sec) * 1000 * 1000.0  + (to.tv_nsec - from.tv_nsec) / 1000.0;
}


void time_asm()
{
	for (unsigned i=0; i < ARRAY_SIZE(asm_vax); i++) {
		uint8_t	b[MAX_OPLEN];

		parse_init(asm_vax[i].str);
		(volatile void) op_asm_vax(b, 0xCAFEBABE, asm_vax[i].width, asm_vax[i].ifp);
		parse_done();
	}
}


void time_dis()
{
	for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++) {
		(volatile void) op_dis_vax(dis_vax[i].b, 0xCAFEBABE, dis_vax[i].width, dis_vax[i].ifp);
	}
}


void time_sim()
{
	for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++) {
		struct fields	fields;

		(volatile void) op_sim(dis_vax[i].b, &fields, dis_vax[i].width, dis_vax[i].ifp);
	}
}


void time_val()
{
	for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++) {
		(volatile void) op_val(dis_vax[i].b, asm_vax[i].width);
	}
}


void time_op()
{
	struct timespec		asm_start, asm_stop;
	struct timespec		dis_start, dis_stop;
	struct timespec		sim_start, sim_stop;
	struct timespec		val_start, val_stop;

	printf("Timing\n");
	printf("------\n");

	/* give I/O system, terminal emulator, and X some time to react before
	   we start timing things.
	 */
	fflush(NULL);
	struct timespec		sleep = {.tv_nsec=1000*1000};	/* 1ms */
	nanosleep(&sleep, NULL);

	/* op_asm_vax */
	long		asm_cnt = 0;

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &asm_start);
	time_asm();
	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &asm_stop);

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &asm_start);
	while (1) {
		for (unsigned i=0; i < 10; i++) {
			asm_cnt++;
			time_asm();
		}
		clock_gettime(CLOCK_THREAD_CPUTIME_ID, &asm_stop);
		if ((timediff(asm_start, asm_stop) > 100000.0) && (asm_cnt > 300))
			break;
	}

	/* op_dis_vax */
	long		dis_cnt = 0;

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &dis_start);
	time_dis();
	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &dis_stop);

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &dis_start);
	while (1) {
		for (unsigned i=0; i < 10; i++) {
			dis_cnt++;
			time_dis();
		}
		clock_gettime(CLOCK_THREAD_CPUTIME_ID, &dis_stop);
		if ((timediff(dis_start, dis_stop) > 100000.0) && (dis_cnt > 300))
			break;
	}

	/* op_sim */
	long	sim_cnt = 0;

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &sim_start);
	time_sim();
	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &sim_stop);

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &sim_start);
	while (1) {
		for (unsigned i=0; i < 10; i++) {
			sim_cnt++;
			time_sim();
		}
		clock_gettime(CLOCK_THREAD_CPUTIME_ID, &sim_stop);
		if ((timediff(sim_start, sim_stop) > 100000.0) && (sim_cnt > 300))
			break;
	}

	/* op_val */
	long	val_cnt = 0;

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &val_start);
	time_val();
	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &val_stop);

	clock_gettime(CLOCK_THREAD_CPUTIME_ID, &val_start);
	while (1) {
		for (unsigned i=0; i < 10; i++) {
			val_cnt++;
			time_val();
		}
		clock_gettime(CLOCK_THREAD_CPUTIME_ID, &val_stop);
		if ((timediff(val_start, val_stop) > 100000.0) && (val_cnt > 300))
			break;
	}

	printf("op_asm_vax()    %g s/call  (%g s, %ld calls)\n", timediff(asm_start, asm_stop) / ARRAY_SIZE(asm_vax) / asm_cnt, timediff(asm_start, asm_stop), asm_cnt);
	printf("op_dis_vax()    %g s/call  (%g s, %ld calls)\n", timediff(dis_start, dis_stop) / ARRAY_SIZE(dis_vax) / dis_cnt, timediff(dis_start, dis_stop), dis_cnt);
	printf("op_sim()        %g s/call  (%g s, %ld calls)\n", timediff(sim_start, sim_stop) / ARRAY_SIZE(dis_vax) / sim_cnt, timediff(sim_start, sim_stop), sim_cnt);
	printf("op_val()        %g s/call  (%g s, %ld calls)\n", timediff(val_start, val_stop) / ARRAY_SIZE(dis_vax) / val_cnt, timediff(val_start, val_stop), val_cnt);

	printf("\n");
}


/***/

/* "timing" -- useful for external profilers, such as cachegrind, perf, ...

   ---

   $ valgrind --tool=cachegrind --cachegrind-out-file=<file> --branch-sim=yes ./test-op --time-asm
   $ cg_annotate --auto=yes <file>

   ---

   $ perf ./test-op --time-asm

 */

void time_op_asm(unsigned cnt)
{
	while (cnt--) {
		for (unsigned i=0; i < ARRAY_SIZE(asm_vax); i++) {
			uint8_t	b[MAX_OPLEN];

			parse_init(asm_vax[i].str);
			(volatile void) op_asm_vax(b, 0xCAFEBABE, asm_vax[i].width, asm_vax[i].ifp);
			parse_done();
		}
	}
}



void time_op_dis(unsigned cnt)
{
	while (cnt--) {
		for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++) {
			(volatile void) op_dis_vax(dis_vax[i].b, 0xCAFEBABE, dis_vax[i].width, dis_vax[i].ifp);
		}
	}
}



void time_op_sim(unsigned cnt)
{
	while (cnt--) {
		for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++) {
			struct fields	fields;

			(volatile void) op_sim(dis_vax[i].b, &fields, dis_vax[i].width, dis_vax[i].ifp);
		}
	}
}



void time_op_val(unsigned cnt)
{
	while (cnt--) {
		for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++) {
			(volatile void) op_val(dis_vax[i].b, asm_vax[i].width);
		}
	}
}



/***/


unsigned from_hex_ch(char ch)
{
	if (isdigit(ch))
		return ch - '0';
	else
		return ch - 'A' + 10;
}


struct afl_input {
	int		width;
	enum ifp	ifp;
	int		cnt;
	uint8_t		b[MAX_OPLEN];
};


void dump_afl(struct afl_input afl)
{
	printf("%d bytes:", afl.cnt);
	for (int i=0; i < afl.cnt; i++) {
		printf(" %02X", afl.b[i]);
	}
	if (afl.cnt == 0)
		printf(" --\n");
	else
		printf("\n");
	printf("width: %d bytes ", afl.width);
	switch (afl.ifp) {
	case IFP_INT: printf("int"); break;
	case IFP_F:   printf("f");   break;
	case IFP_D:   printf("d");   break;
	case IFP_G:   printf("g");   break;
	case IFP_H:   printf("h");   break;
	default:
		UNREACHABLE();
	}
	printf("\n");
}



/***/


struct afl_input afl_input_bin()
{
	struct afl_input	afl = {.width=0};

	afl.cnt = fread(afl.b, 1, MAX_OPLEN, stdin);

	afl.width = 1;
	afl.ifp   = IFP_INT;

	return afl;
}


/***/


void afl_asm()
{
}


void afl_dis_once(struct afl_input afl)
{
	char	buf[100];
	memset(buf, 0x0, sizeof(buf));

	struct dis_ret dis_ret = op_dis_sane(afl.b, 0xCAFEBABE, afl.width, afl.ifp);
	if (dis_ret.cnt == -1) {
		printf("reserved addressing mode.\n");
		return;
	}

	if ((dis_ret.cnt <= 0) || (dis_ret.cnt > MAX_OPLEN)) {
		fprintf(stderr, "wrong no of bytes decoded: %d\n", dis_ret.cnt);
		abort();
	}
	if (dis_ret.cnt > afl.cnt) {
		fprintf(stderr, "redo with more bytes: %d/%d\n", dis_ret.cnt, afl.cnt);
		return;
	}

	/* dump info */
	printf("bytes decoded: %d/%d\n", dis_ret.cnt, afl.cnt);
	printf("op           : '%s'\n", buf);
}


void afl_dis()
{
	struct afl_input afl;

	afl = afl_input_bin();

//	dump_afl(afl);

	char	buf[100];
	memset(buf, 0x0, sizeof(buf));

	for (int width=0; width <= 4; width++) {
		afl.width = 1 << width;
		afl.ifp   = IFP_INT;
		afl_dis_once(afl);
	}
	afl.width = 4;
	afl.ifp   = IFP_F;
	afl_dis_once(afl);
	afl.width = 8;
	afl.ifp   = IFP_D;
	afl_dis_once(afl);
	afl.width = 8;
	afl.ifp   = IFP_G;
	afl_dis_once(afl);
	afl.width = 16;
	afl.ifp   = IFP_H;
	afl_dis_once(afl);
}


void afl_sim_once(struct afl_input afl)
{
	struct fields fields = {.Rn=0};
	memset(&fields, 0xFF, sizeof(fields));

	struct sim_ret sim_ret = op_sim(afl.b, &fields, afl.width, afl.ifp);
	if (sim_ret.cnt == -1) {
		printf("reserved addressing mode.\n");
		return;
	}

	if ((sim_ret.cnt <= 0) || (sim_ret.cnt > MAX_OPLEN)) {
		fprintf(stderr, "wrong no of bytes decoded: %d\n", sim_ret.cnt);
		abort();
	}

	if (sim_ret.cnt > afl.cnt) {
		fprintf(stderr, "redo with more bytes: %d/%d\n", sim_ret.cnt, afl.cnt);
		return;
	}

	/* dump info */
	printf("bytes decoded: %d/%d\n", sim_ret.cnt, afl.cnt);
	if (fields.Rn != -1)
		printf("Rn=%d ", fields.Rn);
	if (fields.Rx != -1)
		printf("Rx=%d ", fields.Rx);
	if (fields.addr != -1)
		printf("addr=%04X_%04X ", SPLIT(fields.addr));
	if ((fields.imm.val[0] != (uint32_t) -1) || (fields.imm.val[1] != (uint32_t) -1)) {
		printf("imm[0]=%04X_%04X ", SPLIT(fields.imm.val[0]));
		if (fields.imm.val[1] != (uint32_t) -1)
			printf("imm[1]=%04X_%04X ", SPLIT(fields.imm.val[1]));
	}
	if (fields.lit6 != -1)
		printf("lit6=%02X ", fields.lit6);
	printf("\n");
}


void afl_sim()
{
	struct afl_input afl;

	afl = afl_input_bin();

//	dump_afl(afl);

	for (int width=0; width <= 4; width++) {
		afl.width = 1 << width;
		afl.ifp   = IFP_INT;
		afl_sim_once(afl);
	}
	afl.width = 4;
	afl.ifp   = IFP_F;
	afl_sim_once(afl);
	afl.width = 8;
	afl.ifp   = IFP_D;
	afl_sim_once(afl);
	afl.width = 8;
	afl.ifp   = IFP_G;
	afl_sim_once(afl);
	afl.width = 16;
	afl.ifp   = IFP_H;
	afl_sim_once(afl);
}


void afl_val()
{
	struct afl_input afl;

	afl = afl_input_bin();

//	dump_afl(afl);

	for (int width=0; width <= 4; width++) {
		afl.width = 1 << width;
		if (op_val(afl.b, afl.width))
			printf("valid.\n");
		else
			printf("reserved addressing mode.\n");
	}
}


/***/

#define TEST_DIR	"afl/op-decode/"
#define TEST_DIR_ASM	"afl/op-asm/"

const char	*asm_tests[] = {
	"r0",  "r9", "r10", "r15",  "ap", "fp", "sp", "pc",
	" r0 ",  " r9 ", " r10 ", " r15 ", " ap ", " fp ", " sp ", " pc ",
	"[r0]", "[r9]", "[r10]", "[r15]", "[ap]", "[fp]", "[sp]", "[pc]",
	" [r0] ", " [r9] ", " [r10] ", " [r15] ", " [ap] ", " [fp] ", " [sp] ", " [pc] ",
	" [ r0 ] ", " [ r9 ] ", " [ r10 ] ", " [ r15 ] ", " [ ap ] ", " [ fp ] ", " [ sp ] ", " [ pc ] ",
};

void afl_output()
{
	/* the dumb output process automatically takes care of duplicates
	   because all but the last of them will be overwritten.
	 */

	/* create directory */
	mkdir("afl/", 0775);   /* ignore errors */
	mkdir(TEST_DIR, 0775); /* ignore errors -- it's fine if it exists */
	mkdir(TEST_DIR_ASM, 0775); /* ignore errors -- it's fine if it exists */


	/* create byte sequence files (decoder tests) */
	for (unsigned i=0; i < ARRAY_SIZE(dis_vax); i++) {
		/* file name = hex bytes + '.auto' */
		char	fname[1000] = {};

		strcpy(fname, TEST_DIR);
		if (dis_vax[i].cnt == 0) {
			sprintf(fname+strlen(fname), "zero-bytes");
		} else {
			for (int j=0; j < dis_vax[i].cnt; j++) {
				assert(strlen(fname) + 100 < sizeof(fname));
				sprintf(fname+strlen(fname), "%02X", dis_vax[i].b[j]);
			}
		}
		sprintf(fname+strlen(fname), ".auto");

		/* create file */
		printf("Writing to %s\n", fname);

		FILE	*f;
		if ((f = fopen(fname, "w")) == NULL) {
			perror("fopen");
			fprintf(stderr, "Can't write to '%s'.\n", fname);
			exit(1);
		}

		/* write */
		for (int j=0; j < dis_vax[i].cnt; j++)
			fprintf(f, "%c", dis_vax[i].b[j]);

		/* close */
		fclose(f);
	}


	/* create asm operand test files */
	for (unsigned i=0; i < ARRAY_SIZE(asm_tests); i++) {
		char	fname[1000] = {};

		strcpy(fname, TEST_DIR_ASM);
		sprintf(fname+strlen(fname), "%0u", i);

		/* create file */
		printf("Writing to %s\n", fname);

		FILE	*f;
		if ((f = fopen(fname, "w")) == NULL) {
			perror("fopen");
			fprintf(stderr, "Can't write to '%s'.\n", fname);
			exit(1);
		}

		/* write */
		fprintf(f, "%s", asm_tests[i]);

		/* close */
		fclose(f);
	}
}


/***/


void help()
{
	fprintf(stderr, "./test-op <mode>\n");
	fprintf(stderr, "\n");
	fprintf(stderr, " mode:\n");
	fprintf(stderr, "   --built-in        built-in test of asm/dis/sim\n");
	fprintf(stderr, "   --built-in-parse  built-in test of parse_bigint/parse_fp\n");
	fprintf(stderr, "   --time            time op_asm+op_dis+op_sim+op_val\n");
	fprintf(stderr, "   --time-asm        time op_asm\n");
	fprintf(stderr, "   --time-dis        time op_dis\n");
	fprintf(stderr, "   --time-sim        time op_sim\n");
	fprintf(stderr, "   --time-val        time op_val\n");
	fprintf(stderr, "\n");
	fprintf(stderr, "   --output          write tests cases to %s directory\n", TEST_DIR);
	fprintf(stderr, "   --test-asm        test asm with a line from stdin\n");
	fprintf(stderr, "   --test-dis        test asm with a byte sequence from stdin\n");
	fprintf(stderr, "   --test-sim        test sim with a byte sequence from stdin\n");
	fprintf(stderr, "   --test-val        test val with a byte sequence from stdin\n");
	fprintf(stderr, "\n");
	fprintf(stderr, " --test-(asm|dis|sim|val), --output are used for testing with American Fuzzy Lop.\n");
	exit(EXIT_FAILURE);
}


int main(int argc, char *argv[argc])
{
#ifdef __AFL_HAVE_MANUAL_CONTROL
	while (__AFL_LOOP(1000)) {
#endif
	if (argc != 2) {
		help();
	}

	if (strcmp(argv[1], "--built-in") == 0) {
		test_asm();
		test_dis();
		test_sim();
	} else if (strcmp(argv[1], "--built-in-parse") == 0) {
		test_parse();

	} else if (strcmp(argv[1], "--time") == 0) {
		time_op();
	} else if (strcmp(argv[1], "--time-asm") == 0) {
		time_op_asm(1000);
	} else if (strcmp(argv[1], "--time-dis") == 0) {
		time_op_dis(1000);
	} else if (strcmp(argv[1], "--time-sim") == 0) {
		time_op_sim(1000);
	} else if (strcmp(argv[1], "--time-val") == 0) {
		time_op_val(1000);

	} else if (strcmp(argv[1], "--test-asm") == 0) {
		afl_asm();
	} else if (strcmp(argv[1], "--test-dis") == 0) {
		afl_dis();
	} else if (strcmp(argv[1], "--test-sim") == 0) {
		afl_sim();
	} else if (strcmp(argv[1], "--test-val") == 0) {
		afl_val();
	} else if (strcmp(argv[1], "--output") == 0) {
		afl_output();
	} else {
		help();
	}
#ifdef __AFL_HAVE_MANUAL_CONTROL
	}
#endif

	/* make valgrind happy */
	mpfr_free_cache();

	return EXIT_SUCCESS;
}

